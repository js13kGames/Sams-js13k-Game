let ctx,canvas={},camera={};function setupCamera(){camera.target={x:player.x,y:player.y},camera.w=canvas.w2,camera.h=canvas.h2,camera.speed=24}function cameraFollow(e,t){t-=50,camera.target.x+camera.speed<e?camera.target.x+=camera.speed:camera.target.x-camera.speed>e?camera.target.x-=camera.speed:camera.target.x=e,camera.target.y+camera.speed<t?camera.target.y+=camera.speed:camera.target.y-camera.speed>t?camera.target.y-=camera.speed:camera.target.y=t,camera.left=camera.target.x-camera.w,camera.right=camera.target.x+camera.w,camera.top=camera.target.y-camera.h,camera.bottom=camera.target.y+camera.h}let aboutguy,computer,player,firstEnemyKilled=!1,enemyUpdateCounter=0;function updateEnemies(){for(let e=enemies.length-1;e>=0;e--)enemies[e].update(),enemies[e].hitPoints<=0&&(generateLoot(enemies[e]),enemies.splice(e,1));if(0!=enemies.length||firstEnemyKilled||(firstEnemyKilled=!0,cantGoDown=!1,level1.platforms[level1.platforms.length-1].fill=platformFill),firstEnemyKilled&&"home"!=currentLevel&&enemies.length<2&&++enemyUpdateCounter%100==0){let e=Math.floor(Math.random()*level1.platforms.length),t=level1.platforms[e];enemies.push(new Enemy(t.x,t.y-80,e))}}class Enemy extends MovingObject{constructor(e,t,i){super(e,t,30,"#cc3f"),this.currentPlatform=i,this.newTarget(),this.targetReachDistance=10,this.targetCounter=0,this.roaming=!0,this.goalReachedAction="none",this.jumpy=!0,this.roamPauseLength=1600,this.attackCounter=0,this.nextAttack=0,this.attackInterval=25,this.facing,this.attackPower=20,this.dashInterval=60,this.nextDash=0,this.dashCount=15}update(){this.attackCounter++;let e=distance(player.x,player.y,this.x,this.y);if(this.nextAttack<this.attackCounter&&e.d<30){let e=!1;"right"==this.facing&&player.x>this.x?e=!0:"left"==this.facing&&player.x<this.x&&(e=!0),e&&(player.hitPoints-=this.attackPower),this.nextAttack=this.attackCounter+this.attackInterval}this.hitPoints<100&&(this.hitPoints+=.2),this.display(),this.roaming&&(player.currentPlatform==this.currentPlatform&&this.nextDash<this.attackCounter&&e.d<120&&(this.nextDash=this.attackCounter+this.dashInterval,this.target=player.x-30+60*Math.random(),this.dashCount=0),this.dashCount<15?(this.dashCount++,this.lrMaxSpeed=5):this.lrMaxSpeed=2,this.x+this.targetReachDistance<this.target?(this.movingRight=!0,this.movingLeft=!1,this.facing="right"):this.x-this.targetReachDistance>this.target?(this.movingRight=!1,this.movingLeft=!0,this.facing="left"):(this.roaming=!1,this.movingRight=!1,this.movingLeft=!1,this.targetCounter%3==0&&("up"==this.goalReachedAction?(this.jump(),console.log("going up")):"down"==this.goalReachedAction&&(this.y+=4,console.log("going down "))),setTimeout(function(e){e.roaming=!0,e.newTarget()},this.roamPauseLength,this)))}newTarget(){this.targetCounter++;let e=level1.platforms[this.currentPlatform];if(this.target=.4*(e.x-e.w2+Math.random()*e.w),this.targetCounter%3==0&&this.jumpy){let t=[];this.currentPlatform>0&&t.push(this.currentPlatform-1),this.currentPlatform+1<level1.platforms.length&&t.push(this.currentPlatform+1);let i=t[Math.floor(Math.random()*t.length)];e=level1.platforms[i],this.target=e.x,i>this.currentPlatform?this.goalReachedAction="up":this.goalReachedAction="down",this.currentPlatform=i}}}function createFriendlyNPCs(){let e=level1.platforms[level1.platforms.length-1];aboutguy=new MovingObject(e.x+150,e.y-30,20,"#22af"),computer=new MovingObject(e.x-150,e.y-30,20,"#447f")}function runFriendlyNPCs(){aboutguy.display(),enableInteraction(aboutguy,"press E",50),computer.display(),enableInteraction(computer,"press E, 1 or 2",50)}function enableInteraction(e,t,i){if(0!=e.screenPos){if(distance(player.x,player.y,e.x,e.y).d<i){e.interactible=!0,ctx.fillStyle="black",ctx.font="10px Georgia";let i=e.screenPos;ctx.fillText(t,i.x,i.y-20)}else e.interactible=!1}else e.interactible=!1}function createPlayer(){let e=level1.platforms[level1.platforms.length-1];"home"==currentLevel?e=level1.platforms[0]:e.x-=130,player=new MovingObject(e.x,e.y-100,20,"#2a2f")}let aboutguydialogs=["welcome to sam's 13k js 2020 game! what's up?","still talking to me, huh"],computerdialogs=["i'm the computer! press 1 to reach another page, press 2 to process data strips."],dialogUI={open:!1,t:0,counter:0,line:[],lineI:0,displayedText:""},aboutguyDialogProgression=0,computerDialogProgression=0;function runDialog(){if(dialogUI.open){if(0!=dialogUI.t){let e=getScreenPos({x:dialogUI.t.x,y:dialogUI.t.y,w2:50,h2:50});dialogUI.x=e.x,dialogUI.y=e.y-70}ctx.fillStyle="white",ctx.fillRect(dialogUI.x,dialogUI.y,100,37),ctx.fillStyle="black",ctx.fillText(dialogUI.displayedText[0],dialogUI.x+5,dialogUI.y+15),ctx.fillText(dialogUI.displayedText[1],dialogUI.x+5,dialogUI.y+26)}aboutguy.interactible||computer.interactible||(dialogUI.open=!1),computer.interactible||(displayLinksUI=!1,displayProcessUI=!1)}function continueDialog(){dialogDone?(dialogUI.open=!1,dialogDone=!1,aboutguy.interactible?aboutguyDialogProgression=(aboutguyDialogProgression+1)%2:computerDialogProgression=0):cutDialog()}let dialogDone=!1,maxCharsPerLine=20;function cutDialog(){let e=makeLine(),t={t:""};e.stop||(t=makeLine()),dialogUI.displayedText=[e.t,t.t]}function makeLine(){let e="",t=!1;for(;!t&&e.length+dialogUI.line[0].length<maxCharsPerLine;)e+=dialogUI.line[0]+" ",dialogUI.line.shift(),0==dialogUI.line.length&&(t=!0,dialogDone=!0);return{t:e,stop:t}}let exitDoorRange=30;function actionButton(){if("home"==currentLevel){let e=aboutguy.interactible;displayLinksUI||displayProcessUI||(e||computer.interactible)&&(dialogUI.open?continueDialog():(dialogUI.open=!0,e?(dialogUI.t=aboutguy,dialogUI.line=aboutguydialogs[aboutguyDialogProgression].split(" ")):(dialogUI.line=computerdialogs[computerDialogProgression].split(" "),dialogUI.t=computer),cutDialog()))}else exitdoor.interactible&&(currentLevel="home",createLevel(),createPlayer(),fadeIn=0,waittime=8)}let cantGoDown=!1;function keypress(){switch(event.keyCode){case 65:player.movingLeft=!0;break;case 68:player.movingRight=!0;break;case 32:player.fallSpeed<8&&player.jump();break;case 83:player.y<killLine&&!cantGoDown&&player.y++;break;case 69:actionButton();break;case 49:displayLinksUI=!("home"!=currentLevel||!computer.interactible||displayProcessUI);break;case 50:displayProcessUI=!("home"!=currentLevel||!computer.interactible||displayLinksUI);break;case 82:break;case 27:displayProcessUI=!1,displayLinksUI=!1,dialogUI.open=!1,inventoryDisplayed=!inventoryDisplayed}}function keyrelease(){switch(event.keyCode){case 65:player.movingLeft=!1;break;case 68:player.movingRight=!1}}let mouseIsPressed=!1,mouseX=0,mouseY=0;function mousePressed(){mouseIsPressed=!0,mouseX=event.clientX-canvas.x,mouseY=event.clientY-canvas.y,displayLinksUI||displayProcessUI||player.shoot(mouseX,mouseY,15)}function mouseReleased(){mouseIsPressed=!1}let inventoryDisplayed=!1;function addToInventory(e,t){let i=!1;for(let s=0;s<inventory.length;s++)inventory[s].name==e&&(i=!0,inventory[s].quantity+=t);i||inventory.push({name:e,quantity:t})}function removeItem(e,t){0!=haveItem(e)&&(inventory[i].quantity-=t,0==inventory[i].quantity&&inventory.splice(i,1))}function haveItem(e,t){let i=!1;for(let s=0;s<inventory.length;s++)inventory[s].name==e&&inventory[s].quantity>=t&&(i=s);return i}function findAndRemoveItem(e,t){haveItem(e,t)&&removeItem(e,t)}let enemyLootTable=[{name:"angry data strip",fill:"grey",quantity:{min:12,r:14},chance:1},{name:"gold",fill:"gold",quantity:{min:1,r:5},chance:.5},{name:"html bits",fill:"lightblue",quantity:{min:3,r:52},chance:.8},{name:"health pot",fill:"tomato",quantity:{min:1,r:3},chance:.2}],items=[],inventory=[];function generateLoot(e){let t=Math.random();for(let i=0;i<enemyLootTable.length;i++)if(t<enemyLootTable[i].chance){let t=enemyLootTable[i],s=Math.floor(t.quantity.min+Math.random()*t.quantity.r);items.push(new Item(e.x,e.y-50,10,t.fill,t.name,s));let l=items.length-1;items[l].impactForce.x=Math.floor(6+12*Math.random()),Math.random()>.5&&(items[l].impactForce.x*=-1),items[l].initJumpForce=11,items[l].jump()}}function updateItems(){for(let e=0;e<items.length;e++)items[e].update()}class Item extends MovingObject{constructor(e,t,i,s,l,a){super(e,t,i,s),this.name=l,this.looted=!1,this.lootableRange=80,this.pickupRange=10,this.lootSpeed=1,this.quantity=a}update(){if(!this.looted){let e=distance(this.x,this.y,player.x,player.y);if(e.d<this.pickupRange)this.looted=!0,addToInventory(this.name,this.quantity);else if(e.d<this.lootableRange){this.lootSpeed++;let t=this.lootSpeed/e.d;this.speedVect={y:t*e.opp,x:t*e.adj},this.x+=this.speedVect.x,this.y+=this.speedVect.y,this.fallSpeed=0}else this.lootSpeed>1&&this.lootSpeed--;this.display(),0!=this.screenPos&&(ctx.fillStyle="#000b",ctx.font="8px bold",ctx.fillText(this.quantity,this.screenPos.x+15,this.screenPos.y-15))}}}class MovingObject extends DisplayObject{constructor(e,t,i,s){super(e,t,i,i),this.fill=s,this.hasGravity=!0,this.fallAcc=2,this.lrMaxSpeed=10,this.lrAcc=1,this.lrFriction=2,this.initJumpForce=25,this.movingLeft=!1,this.movingRight=!1,this.jumpForce=0,this.jumpDecel=2.2,this.fallSpeed=0,this.lrSpeed=0,this.impactForce={x:0,y:0},this.hitPoints=100}display(){this.moveLeftRight(),this.applyPhysics(),this.updateOnScreenPosition(),0!=this.screenPos&&(ctx.fillStyle=this.fill,ctx.fillRect(this.screenPos.x,this.screenPos.y,this.w,this.h),this.hitPoints<100&&this.displayHealthBar())}displayHealthBar(){let e=this.screenPos.y-25,t=this.screenPos.x;ctx.fillStyle="white",ctx.fillRect(t,e,30,10),ctx.fillStyle="red",ctx.fillRect(t,e,30*this.hitPoints/100,10)}jump(){this.jumpForce=this.initJumpForce}moveLeftRight(){this.movingLeft&&!this.movingRight?(this.lrSpeed-=this.lrAcc,this.lrSpeed=Math.max(this.lrSpeed,-this.lrMaxSpeed)):this.movingRight&&!this.movingLeft?(this.lrSpeed+=this.lrAcc,this.lrSpeed=Math.min(this.lrSpeed,this.lrMaxSpeed)):this.lrSpeed+this.lrFriction<0?this.lrSpeed+=this.lrFriction:this.lrSpeed-this.lrFriction>0?this.lrSpeed-=this.lrFriction:this.lrSpeed=0,this.impactForce.x>0?this.impactForce.x--:this.impactForce.x<0&&this.impactForce.x++,this.x+=this.lrSpeed+this.impactForce.x}applyPhysics(){this.updateFallSpeed(),this.impactForce.y>0&&console.log(this.impactForce.y),this.jumpForce-this.jumpDecel>0?this.jumpForce-=this.jumpDecel:this.jumpForce=0,this.y+=this.fallSpeed-this.jumpForce}updateFallSpeed(){let e=level1.platforms,t=killLine;for(let i=0;i<e.length;i++)this.x>e[i].x-e[i].w2&&this.x<e[i].x+e[i].w2&&e[i].y>=this.y+this.h/2&&e[i].y<t&&(t=e[i].y,this.currentPlatform=i);this.y+this.h/2+this.fallSpeed<t?this.fallSpeed+=this.fallAcc:(this.y=t-this.h/2,this.impactForce.y=this.fallSpeed,this.impactForce.y>36&&(this.hitPoints-=this.impactForce.y/2),this.fallSpeed=0)}}class DisplayObject{constructor(e,t,i,s){this.x=e,this.y=t,this.w=i,this.h=s,this.w2=this.w/2,this.h2=this.h/2}updateOnScreenPosition(){checkCollision(getBounds(this),camera)?this.screenPos=getScreenPos(this):this.screenPos=!1}limitX(){this.x=Math.min(Math.max(this.x,-sceneW/2),sceneW/2)}shoot(e,t,i){projectiles.push(new Projectile(this.x,this.y,4,"black",i,e,t))}}function checkCollision(e,t){return(e.right>=t.left&&e.right<=t.right||e.left>=t.left&&e.left<=t.right||e.left<=t.left&&e.right>=t.right)&&(e.bottom>=t.top&&e.bottom<=t.bottom||e.top>=t.top&&e.top<=t.bottom||e.top<=t.top&&e.bottom>=t.bottom)}function getScreenPos(e){return{x:canvas.w2+e.x-camera.target.x-e.w2,y:canvas.h2+e.y-camera.target.y-e.h2}}class Projectile extends MovingObject{constructor(e,t,i,s,l,a,o){super(e,t,i,s),this.destroyed=!1,this.y-=20,this.updateOnScreenPosition();let n=this.screenPos,r=distance(n.x,n.y,a,o),c=l/r.d;this.speedVect={y:c*r.opp,x:c*r.adj},this.hasGravity=!1,this.lifeTimer=0}updateProjectile(){this.lifeTimer++,this.destroyed?this.display():(this.x+=this.speedVect.x,this.y+=this.speedVect.y,this.updateOnScreenPosition(),0!=this.screenPos&&(this.checkForCollisions(level1.platforms,!1),this.checkForCollisions(enemies,10),this.checkWallCollisions(),ctx.fillStyle=this.fill,ctx.fillRect(this.screenPos.x,this.screenPos.y,this.w,this.h)))}checkWallCollisions(){(this.x<-sceneW/2||this.x>sceneW/2)&&this.stopProjectile()}checkForCollisions(e,t){for(let i=0;i<e.length;i++)if(checkCollision(getBounds(e[i]),getBounds(this))&&(this.stopProjectile(),0!=t)){e[i].hitPoints-=t;let s=t/2;e[i].impactForce.x+=Math.min(Math.max(e[i].x-this.x,-s),s)}}stopProjectile(){this.speedVect.x=0,this.speedVect.y=0,this.destroyed=!0}}let projectiles=[];function updateProjectiles(){for(let e=projectiles.length-1;e>=0;e--)projectiles[e].updateProjectile(),projectiles[e].lifeTimer>50&&projectiles.splice(e,1)}let waittime=5;function runFadeIn(){let e=1;fadeIn>waittime&&(e=1-(fadeIn-waittime)/30),e>0&&(ctx.fillStyle="rgba(0,0,0,"+e+")",ctx.fillRect(0,0,canvas.w,canvas.h)),fadeIn++}let linksUIel,textform,listform,displayLinksUI=!1,lastdisplayState=!1,linksUI={w:260,h:80},linkLoadTime=800;function runLinksUI(){if(displayLinksUI){if(!lastdisplayState){lastdisplayState=!0,dialogUI.open=!1,linksUI.x=canvas.w2-linksUI.w/2+canvas.x,linksUI.y=canvas.h2-linksUI.h/2+canvas.y,(linksUIel=document.createElement("div")).setAttribute("style",`padding:10px;position:fixed;left:${linksUI.x}px;top:${linksUI.y}px;width:${linksUI.w}px;height:${linksUI.h}px;background-color:white;font-size:14px;`);let e="";for(let t=0;t<favorites.length;t++)e+=`<option value="${favorites[t]}">status: unknown</option>`;linksUIel.innerHTML=`Choose from favorites:<br><input list="browsers" name="browser" id="browser" onchange='inputListChanged()'>\n      <datalist id="browsers">\n      ${e}\n      </datalist></input>\n      <br>Or type url name:<br>\n      <input type="text" id="fname" name="fname" value="custom url" onkeydown='formKeyDown()' onclick='formclick()'>\n      <div style='font-size:12px;position:absolute; right:26px;top:10px;'><br>select a list<br>item, or type<br>url name and <br>press enter</div>\n      `,document.body.appendChild(linksUIel),textform=document.getElementById("fname"),listform=document.getElementById("browser")}}else lastdisplayState&&linksUIel.remove(),lastdisplayState=!1}function formclick(){textform.value=""}function formKeyDown(){13==event.keyCode&&(textform.value=textform.value.trim(),goToLink())}function inputListChanged(){textform.value=listform.value,goToLink()}function goToLink(){let e=textform.value,t=listform.value,i=t;e!=t&&(i=e),linksUIel.innerHTML="loading "+i+"!",fadeIn=0,waittime=24,setTimeout(function(){displayLinksUI=!1,currentLevel=0,createLevel(),createPlayer()},linkLoadTime)}let displayProcessUI=!1,favorites=["link1","link2","link3","link4"],pUI={w:200,h:200,last:!1,el:0};function runProcessUI(){if(displayProcessUI&&!pUI.last){pUI.x=canvas.w2-pUI.w/2,pUI.y=canvas.h2-pUI.h/2,dialogUI.open=!1,pUI.el=div(pUI,"white");let e={x:pUI.x,y:pUI.y,w:pUI.w,h:pUI.h/2};pUI.dataButton=button(e,"yellow","but1","processDataStrips"),e.y+=pUI.h/2,pUI.htmlButton=button(e,"orange","but2","processHTMLBits")}else!displayProcessUI&&pUI.last&&(pUI.el.remove(),pUI.dataButton.remove(),pUI.htmlButton.remove());pUI.last=displayProcessUI}let dataCost=50;function processDataStrips(){console.log("data strps"),findAndRemoveItem(enemyLootTable[0].name,dataCost)}let level1,htmlCost=100;function processHTMLBits(){console.log("html bits"),findAndRemoveItem(enemyLootTable[2].name,htmlCost)}function div(e,t){let i=document.createElement("div");return document.body.appendChild(i),i.setAttribute("style",`position:fixed; left:${e.x}px;top:${e.y}px;width:${e.w}px;height:${e.h}px;background-color:${t};`),i}function button(e,t,i,s){let l=div(e,t);return l.id=i,at(l,"onclick",s+"()"),at(l,"onmouseenter",`hover("${i}")`),at(l,"onmouseleave",`unhover("${i}","${t}")`),l}function at(e,t,i){e.setAttribute(t,i)}function hover(e,t){document.getElementById(e).style.backgroundColor="grey"}function unhover(e,t){document.getElementById(e).style.backgroundColor=t}let exitdoor,currentLevel="home",sceneW=0,fadeIn=0,enemies=[];function createLevel(){if(enemies=[],items=[],firstEnemyKilled=!1,"home"==currentLevel){sceneW=canvas.w;let e=[[50,killLine-100,100],[-60,killLine-60,100],[0,killLine,canvas.w]];level1=new Level(e,sceneW,Math.abs(e[0][1]-e[e.length-1][1])),cantGoDown=!1,createFriendlyNPCs()}else{let e=(sceneW=2*canvas.w)/2,t=[[0,killLine,sceneW]],i=8,s=5+Math.floor(random()*i),l=killLine,a=50,o=150,n=65,r=60,c=.6*(-e+random()*sceneW),h=Math.min(a+random()*o,sceneW-c);for(let i=0;i<s-1;i++){o=i%4==2?300:40,l-=n,t.push([c,l,h]);let s=50,p=Math.floor(3*random())-1;(c<0-s||c>0+s)&&(p=Math.abs(e-c)/(e-c)),c+=p*Math.floor(random()*r),h=Math.min(a+random()*o,(sceneW-c)/2)}let p=t[t.length-1];p[0]=sceneW/8,p[2]=1.2*sceneW;let m=(level1=new Level(t,sceneW,Math.abs(t[0][1]-t[t.length-1][1]))).platforms.length-1;(p=level1.platforms[m]).fill="orange",level1.text404=new DisplayObject(p.x-10,p.y-10,300,300),exitdoor=new MovingObject(p.x+50,p.y-50,20,"#a22f"),cantGoDown=!0,enemies.push(new Enemy(p.x,p.y-80,m)),enemies[0].jumpy=!1}}class Level{constructor(e,t,i){this.platforms=[];for(let t=0;t<e.length;t++)this.platforms.push(new Platform(e[t][0],e[t][1],e[t][2]));this.bgFill="#ddff";let s=t/4;this.walls=[new DisplayObject(-t+s,0,t/2,2e3),new DisplayObject(t/2+s,0,t/2,2e3),new DisplayObject(0,killLine+500,2e3,1e3)]}displayBackground(){ctx.fillStyle=this.bgFill,ctx.fillRect(0,0,canvas.w,canvas.h)}display404Background(){this.text404.updateOnScreenPosition(),ctx.font="100px Georgia",ctx.fillStyle="black",ctx.fillText("404",this.text404.screenPos.x,this.text404.screenPos.y),ctx.font="30px Georgia",ctx.fillText("return to last page...",this.text404.screenPos.x,this.text404.screenPos.y+50)}displayPlatforms(){for(let e=0;e<this.platforms.length;e++)this.platforms[e].display();ctx.fillStyle="yellow";for(let e=0;e<this.walls.length;e++){let t=this.walls[e];t.updateOnScreenPosition();let i=t.screenPos;0!=i&&ctx.fillRect(i.x,i.y,t.w,t.h)}}}let platformHeight=10,platformFill="#a43f";class Platform extends DisplayObject{constructor(e,t,i){super(e,t,i,platformHeight),this.fill=platformFill}display(){this.updateOnScreenPosition(),0!=this.screenPos&&(ctx.fillStyle=this.fill,ctx.fillRect(this.screenPos.x,this.screenPos.y,this.w,this.h))}}window.onload=start;let killLine=500;function start(){fadeIn=0,createCanvas(),createLevel(),createPlayer(),setupCamera(),setInterval(run,33)}function run(){let e="home"==currentLevel;cameraFollow(player.x,player.y),level1.displayBackground(),e||level1.display404Background(),level1.displayPlatforms(),e?runFriendlyNPCs():runExitDoor(),updateEnemies(),player.limitX(),player.display(),player.hitPoints<100&&(player.hitPoints+=.1),updateProjectiles(),runDialog(),updateItems(),runFadeIn(),runProcessUI(),runLinksUI()}function runExitDoor(){exitdoor.display(),enableInteraction(exitdoor,"press E to return home",exitDoorRange)}
