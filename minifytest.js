let aContext;const twoPI=2*Math.PI;let samprate,startSound=()=>{window.AudioContext=window.AudioContext||window.webkitAudioContext,aContext=new AudioContext,samprate=aContext.sampleRate},preloadSound=(e,t,a,i)=>{let s=[],n=samprate*(t.a+t.d+t.r),l=samprate/e,o=flo(l)*a,r=l/twoPI,c=[];for(let e=0;e<o;e++)c.push(i(e,r));for(let e=0;e<n;e++)s[e]=.4*t.level(e)*c[e%o];return s},playSound=(e,t,a,i,s)=>{let n=new Float32Array(e.length);for(var l=0;l<e.length;l++)n[l]=t*e[l];let o=aContext.createBuffer(1,n.length,samprate);o.copyToChannel(n,0);let r=aContext.createBufferSource();r.buffer=o;let c=aContext.createBiquadFilter();r.connect(c),c.connect(aContext.destination),r.start(0),c.type=a,c.frequency.value=i,c.gain.value=s};class Envelope{constructor(e,t,a,i){this.a=e,this.d=t,this.s=a,this.r=i,this.aS=e*samprate,this.dS=t*samprate,this.rS=i*samprate,this.rT=this.aS+this.dS}level(e){return e<this.aS?e/this.aS:e<this.rT?1-(1-this.s)*(e-this.aS)/this.dS:this.s*(1-(e-this.rT)/this.rS)}}let bar=1800,maxbars=16,startBeatMachine=()=>setInterval(newbar,bar),beatinput=[{vals:"x x 0 x xxx 0 x x x xxx x x",beatval:32,f:playHats},{vals:"x  xx",beatval:8,f:playKick,v:200,p:!1},{vals:"xoxxx",beatval:5,f:playSnare,p:!1},{vals:"",beatval:3,f:playBlaster,v:360,p:!1},{vals:"/  --",beatval:6,f:playWobbleBass,v:0,p:!1},{vals:"",beatval:8,f:playHardHat,p:!1},{vals:"  M   N",beatval:8,f:playNoiseySynth,v:0,p:!1},{vals:"MNRW  V  W  YZYW",beatval:16,f:playSine,v:0,p:!1}],bars=0,section=0;function noteToFreq(e){return 13.75*2**((e-9)/12)}function newbar(){let e=beatinput[0],t=beatinput[6],a=beatinput[4],i=beatinput[1],s=beatinput[5],n=beatinput[2];switch(section){case 0:e.p=!0,t.p=!0,a.p=!0,wubfactor=200;break;case 1:t.p=!1,i.p=!0,s.p=!0,wubfactor=400;break;case 2:n.p=!0,snarerelease=.2,wubfactor=600;break;case 3:t.p=!0,i.p=!1,wubfactor=200}section%2==1&&(random()>.3&&bars%2==1?(i.vals="x  x  x x     x",i.beatval=16):(i.vals="x  xx",i.beatval=8)),section>=0&&(bars%2==0?(n.vals="x xxx",n.beatval=5,s.vals="xoooxooo"):(n.vals="x  x",n.beatval=8,s.vals="oxox0x0x"));for(let e=0;e<beatinput.length;e++)if(beatinput[e].p)for(let t=0;t<beatinput[e].vals.length;t++)"x"==beatinput[e].vals[t]?null!=beatinput[e].v?setTimeout(function(e,t){e(t)},t*bar/beatinput[e].beatval,beatinput[e].f,beatinput[e].v):setTimeout(function(e){e()},t*bar/beatinput[e].beatval,beatinput[e].f):null!=beatinput[e].v&&" "!=beatinput[e].vals[t]&&setTimeout(function(e,t){e(t)},t*bar/beatinput[e].beatval,beatinput[e].f,noteToFreq(beatinput[e].vals.charCodeAt(t)-20));++bars==maxbars&&(bars=0,section++)}let sine4counter=0,sine4fact=.2,constSineB=(e,t)=>constrain(Math.round(Math.sin(e/(t+e/100))),0,.1),constSineB2=(e,t)=>constrain(Math.round(Math.sin(e/(t+e/1e3))),0,.1),noisey=(e,t)=>.02*Math.random(),noisey2=(e,t)=>Math.random()*constrain(Math.round(Math.sin(e/(e+t))),0,.13),constSine=(e,t)=>constrain(Math.sin(e/t),-.2,.2),constSine2=(e,t)=>constrain(.5*(Math.sin(e/t)+Math.sin(e/(20+t))),0,.1),constSine3=(e,t)=>constrain(.2*Math.random()*(Math.sin(e/t)+Math.sin(e/(100+t))),0,.1),constSine4=(e,t)=>constrain(Math.random()*sine4fact+.3*(Math.sin(e/t)+.3*Math.sin(e/(2+t))),0,.1),snarerelease=.3;function playSnare(){playSound(preloadSound(10,new Envelope(.02,.01,.3,snarerelease),4,noisey2),5,"highpass",2200,4)}function playHats(){playSound(preloadSound(400,new Envelope(.01,.01,.1,.2),40,noisey),14,"highpass",1400,12)}let wubfactor=560;function playWobbleBass(e){playSound(preloadSound(e,new Envelope(.05,.51,.2,.51),60,constSine2),5,"lowshelf",wubfactor,10)}function playNoiseySynth(e){playSound(preloadSound(e,new Envelope(.01,.11,.3,1.45),50,constSine4),8,"lowpass",1500,8),++sine4counter%12==0&&(sine4fact=1-sine4fact)}function playHardHat(){playSound(preloadSound(8,new Envelope(.01,.01,.11,.13),1,constSine3),6,"lowshelf",2240,12)}function playKick(e){playSound(preloadSound(e,new Envelope(.01,.11,.3,.35),500,constSineB),18,"lowpass",180,12)}function playBlaster(e,t){playSound(preloadSound(e,new Envelope(.01,.11,.3,.25),100,constSineB2),t,"highpass",1080,8)}function playSine(e){playSound(preloadSound(e,new Envelope(.01,.11,.3,.35),1,constSine),1,"notch",280,28)}function playDamageFX(){playSound(preloadSound(20,new Envelope(.01,.11,.3,.31),60+Math.floor(20*Math.random()),constSine3),14,"highshelf",1500,2)}let ctx,aboutguy,player,playerMoving,canvas={},camera={},setupCamera=()=>{camera.target={x:player.x,y:player.y},camera.w=canvas.w2,camera.h=canvas.h2,camera.speed=24},cameraFollow=(e,t)=>{t-=50,reach(camera.target,{x:e,y:t},camera.speed),camera.left=camera.target.x-camera.w,camera.right=camera.target.x+camera.w,camera.top=camera.target.y-camera.h,camera.bottom=camera.target.y+camera.h},firstEnemyKilled=!1,enemyUpdateCounter=0,maxEnemies=3;function updateEnemies(){if("home"!=currentLevel&&"start"!=currentLevel){for(let e=enemies.length-1;e>=0;e--)enemies[e].update(),enemies[e].hitPoints<=0&&(generateLoot(enemies[e]),enemies.splice(e,1),levelData.completion=Math.min(levelData.completion+5,100),level1.uncorrupting=!0,levelData.completion<100&&setTimeout(function(){level1.uncorrupting=!1},2e3));if(0==enemies.length&&!firstEnemyKilled){cantGoDown=!1,last(level1.platforms).fill=platformFill,firstEnemyKilled=!0,levelData.unlocked=!0}if(firstEnemyKilled&&!level1.cleared&&enemies.length<maxEnemies&&levelData.completion<100&&++enemyUpdateCounter%100==0){let e=randInt(l(level1.platforms)),t=level1.platforms[e];enemies.push(new Enemy(t.x,t.y-80,e))}}}class Enemy extends MovingObject{constructor(e,t,a){super(e,t,40,"#cc30"),this.currentPlatform=a,this.newTarget(),this.targetReachDistance=10,this.targetCounter=0,this.roaming=!0,this.goalReachedAction="none",this.jumpy=!0,this.roamPauseLength=1600,this.attackCounter=0,this.nextAttack=0,this.attackInterval=25,this.facing,this.attackPower=20,this.dashInterval=20,this.nextDash=0,this.dashCount=15,this.facing="left",this.lastRoamingState=!1,this.attackAnimOverTimeout,this.model=new CoolPath(0,0,edata)}update(){this.attackCounter++;let e=distance(player.x,player.y,this.x,this.y);this.nextAttack<this.attackCounter&&e.d<30&&player.currentPlatform==this.currentPlatform&&(damagePlayer(this.attackPower),this.animate(2),this.nextAttack=this.attackCounter+this.attackInterval,this.attackAnimOverTimeout=setTimeout(function(e){e.roaming?e.animate(1):e.animate(0)},400,this)),this.hitPoints<100&&(this.hitPoints+=.2),this.display(),this.roaming&&(player.currentPlatform==this.currentPlatform&&this.nextDash<this.attackCounter&&e.d<220?(this.nextDash=this.attackCounter+this.dashInterval,this.dashCount=0,this.target=player.x-30+60*Math.random(),clearTimeout(this.attackAnimOverTimeout),this.animate(3)):this.lastRoamingState||this.animate(1),this.dashCount<15?(this.dashCount++,this.lrMaxSpeed=7,15==this.dashCount&&this.animate(1)):this.lrMaxSpeed=2,this.x+this.targetReachDistance<this.target?this.goRight():this.x-this.targetReachDistance>this.target?this.goLeft():(this.roaming=!1,this.movingRight=!1,this.movingLeft=!1,this.targetCounter%3==0&&("up"==this.goalReachedAction?this.jump():"down"==this.goalReachedAction&&(this.y+=4)),this.animate(0),setTimeout(function(e){e.roaming=!0,e.newTarget()},this.roamPauseLength,this))),0!=this.screenPos&&(this.model.x=this.screenPos.x+20,this.model.y=this.screenPos.y+20,this.model.update(ctx,"left"==this.facing)),this.lastRoamingState=this.roaming}animate(e){clearTimeout(this.attackAnimOverTimeout),this.model.selectAnimation(e)}newTarget(){this.targetCounter++;let e=level1.platforms[this.currentPlatform],t=level1.platforms[player.currentPlatform];if(e.y==t.y)this.target=.4*(e.x-e.w2+Math.random()*e.w);else{let t=getBounds(e),a=!1;for(let i=0;i<level1.platforms.length;i++){if(a)return;let s=getBounds(level1.platforms[i]),n=-1,l=-1;if(t.left>=s.left&&t.right<=s.right?(n=t.left,l=e.w):t.left<=s.left&&t.right>=s.right?(n=s.left,l=level1.platforms[i].w):s.right>=t.left&&s.right<=t.right?(n=t.left,l=s.left+level1.platforms[i].w-t.left):s.left>=t.left&&s.left<=t.right&&(n=s.left,l=t.left+e.w-s.left),-1!=n){let t=level1.platforms[i].y-e.y;this.y<player.y&&t>0&&t<150?(console.log("moving down"),a=!0,this.target=n+randInt(l),this.goalReachedAction="down"):this.y>player.y&&t<0&&t>-100&&(a=!0,this.target=n+randInt(l),this.goalReachedAction="up")}}a||(this.target=.4*(e.x-e.w2+Math.random()*e.w))}}}function createFriendlyNPCs(){let e=level1.platforms[level1.platforms.length-1];aboutguy=new MovingObject(e.x+150,e.y-30,20,"#22af")}function runFriendlyNPCs(){aboutguy.display(),enableInteraction(aboutguy,"press E",50)}function enableInteraction(e,t,a){if(0!=e.screenPos){if(distance(player.x,player.y,e.x,e.y).d<a){e.interactible=!0,ctx.fillStyle="black",ctx.font="10px Georgia";let a=e.screenPos;ctx.fillText(t,a.x,a.y-20)}else e.interactible=!1}else e.interactible=!1}function createPlayer(){let e=level1.platforms[level1.platforms.length-1];"home"==currentLevel?e=level1.platforms[0]:e.x-=130,(player=new MovingObject(e.x,e.y-100,40,"#2a20")).facing="left",setupCamera()}let lastPlayerMovingState=!1,playerJumping=!1;function updatePlayer(){player.limitX(),player.display(),playerModel.x=player.screenPos.x+20,playerModel.y=player.screenPos.y+10,playerMoving=!1,(player.movingLeft||player.movingRight)&&(playerMoving=!0),(player.jumpForce>0||player.fallSpeed>0)&&!playerJumping?(playerJumping=!0,playerModel.fullRig.selectAnimation(2)):0==player.jumpForce&&playerJumping?(playerJumping=!1,resetPlayerAnimation()):playerMoving&&!lastPlayerMovingState?playerModel.fullRig.selectAnimation(0):!playerMoving&&lastPlayerMovingState&&playerModel.fullRig.selectAnimation(3),lastPlayerMovingState=playerMoving,playerModel.update(ctx,"left"==player.facing),player.hitPoints<100&&(player.hitPoints+=.1),player.impactForce>36&&(playDamageFX(),playerModel.selectAnimation(1),setTimeout(function(){resetPlayerAnimation()},400)),aBar.health.innerHTML="health: "+Math.floor(player.hitPoints)}function resetPlayerAnimation(){playerMoving?playerModel.fullRig.selectAnimation(0):playerModel.fullRig.selectAnimation(3)}function damagePlayer(e){player.hitPoints-=e,playDamageFX(),playerModel.selectAnimation(1),setTimeout(function(){resetPlayerAnimation()},400)}let texts=["Hmm? # Oh! You must be from the cleaning service. # Thank goodness you're here. # Our web page is being attacked by a mysterious slimey virus! # Our pages have been replaced by fake 404s, monsters and slime. # Yuck! It's revolting! Here, let me add our directory to your favorites.","We must clear the virus from this website. # I suspect other infected files have been implanted in the servers. # Bring back any clues you might find and we'll track them down!"],dUI={open:!1,t:0,counter:0,line:[],lineI:0,displayedText:""},dialogNum=0,dialogDone=!1,maxCharsPerLine=20,runDialog=()=>{if(dUI.open){if(0!=dUI.t){let e=getScreenPos({x:dUI.t.x,y:dUI.t.y,w2:50,h2:50});dUI.x=e.x,dUI.y=e.y-70}cFill("white"),cRect(dUI.x,dUI.y,190,42),cFill("black"),cFont("16px Courier New"),cText(dUI.displayedText[0],dUI.x+5,dUI.y+18),cText(dUI.displayedText[1],dUI.x+5,dUI.y+36)}aboutguy.interactible||(dUI.open=!1)},continueDialog=()=>{if(dialogDone){switch(dUI.open=!1,dialogDone=!1,dialogNum){case 0:for(let e=0;e<2;e++)newLevel(allLinkNames[e]);updateFavorites()}aboutguy.interactible&&dialogNum<texts.length-1&&dialogNum++}else cutDialog()},cutDialog=()=>{let e=makeLine(),t={t:""};e.stop||(t=makeLine()),dUI.displayedText=[e.t,t.t]},makeLine=()=>{let e="",t=!1,a=!1;for(;!t&&!a&&e.length+dUI.line[0].length<maxCharsPerLine;)"#"==dUI.line[0]?a=!0:e+=dUI.line[0]+" ",dUI.line.shift(),0==dUI.line.length&&(t=!0,dialogDone=!0);return{t:e,stop:t}},actionButton=()=>{"home"==currentLevel&&aboutguy.interactible&&(dUI.open?continueDialog():(dUI.open=!0,dUI.t=aboutguy,dUI.line=texts[dialogNum].split(" "),revealedLink.includes("_")||pickNextLinkAward(),cutDialog()))},cantGoDown=!1;function keypress(){if(!tFormSelected)switch(event.keyCode){case 65:player.goLeft();break;case 68:player.goRight();break;case 32:player.fallSpeed<8&&player.jump();break;case 83:player.y<killLine&&!cantGoDown&&player.y++;break;case 69:actionButton();break;case 27:dUI.open=!1}}function keyrelease(){if(!tFormSelected)switch(event.keyCode){case 65:player.movingLeft=!1;break;case 68:player.movingRight=!1}}let mouseIsPressed=!1,mouseX=0,mouseY=0,cantShoot=!1;const playerShotCooldown=200;let mousePressed=()=>{mouseIsPressed=!0,mouseX=event.clientX-canvas.x,mouseY=event.clientY-canvas.y,"start"==currentLevel||cantShoot||(playBlaster(1800,3),player.shoot(mouseX,mouseY,15),playerModel.selectAnimation(4),cantShoot=!0,setTimeout(function(){resetPlayerAnimation(),cantShoot=!1},200))},mouseReleased=()=>mouseIsPressed=!1,datastrip=0,addLoot=()=>{updateInv(++datastrip),datastrip>dataCost&&(datastrip-=dataCost,processDataStrips(),updateInv(datastrip))},updateInv=e=>{let t="";""!=revealedLink&&(t=". Next url: "+revealedLink),aBar.inventory.innerHTML="data strips: "+e+" / "+dataCost,aBar.research.innerHTML=t},items=[],generateLoot=e=>{let t=5+randInt(15);for(let a=0;a<t;a++){items.push(new Item(e.x,e.y-50,10,"grey"));let t=items[items.length-1];t.impactForce.x=6+randInt(12),Math.random()>.5&&(t.impactForce.x*=-1),t.initJumpForce=11,t.jump()}},updateItems=()=>{for(let e=items.length-1;e>=0;e--)items[e].update(),items[e].looted&&items.splice(e,1)};class Item extends MovingObject{constructor(e,t,a,i){super(e,t,a,i),this.looted=!1,this.v=1}update(){if(!this.looted){let e=distance(this.x,this.y,player.x,player.y);if(e.d<10)this.looted=!0,addLoot();else if(e.d<80){this.v++;let t=this.v/e.d;this.x+=t*e.adj,this.y+=t*e.opp,this.fallSpeed=0}else this.v>1&&this.v--;this.display()}}}let ns1=58,ns2=93;class CoolPath{constructor(e,t,a){this.x=e,this.y=t,this.cmess,this.scale=1.5,this.colors=a.c,this.model=a.m,this.rig=a.r,this.animations=a.a;for(let e=0;e<this.rig.length;e++)this.rig[e].isRoot&&(this.fullRig=new RigShape(e,this.scale,this.model,this.rig,this.animations,this.colors));this.selectAnimation(1),this.timeCounter=0}selectAnimation(e){this.selectedAnimation=e,this.fullRig.selectAnimation(e)}update(e,t){this.fullRig.updateRotationValues(),ctx.translate(this.x,this.y),t&&ctx.scale(-1,1),this.fullRig.display(ctx),ctx.resetTransform(),this.timeCounter++,this.timeCounter>this.animations[this.selectedAnimation].animLength&&(this.timeCounter=0)}}class RigShape{constructor(e,t,a,i,s,n){this.colors=n,this.model=a,this.rig=i,this.animations=s,this.shapeIndex=e,this.origin={x:this.rig[e].origin.x*t,y:this.rig[e].origin.y*t},this.rotation=0,this.paths=[],this.fill,this.stroke,this.timeCounter=0;for(let a=0;a<this.model.length;a++)if(this.model[a].shape==e){let e=this.model[a].origin.x*t,i=this.model[a].origin.y*t,s="M "+e+" "+i+" ";for(let n=0;n<this.model[a].segments.length;n++){s+=this.model[a].segments[n].type+" ";for(let l=0;l<this.model[a].segments[n].points.length;l++)s+=(e=this.model[a].segments[n].points[l].x*t)+" "+(i=this.model[a].segments[n].points[l].y*t),s+=" "}this.paths.push({path:new Path2D(s),stroke:this.model[a].stroke,fill:this.model[a].fill})}this.connections=[];for(let a=0;a<this.rig[e].connections.length;a++)this.connections.push({shape:new RigShape(this.rig[e].connections[a].shape,t,this.model,this.rig,this.animations,this.colors),x:this.rig[e].connections[a].x*t,y:this.rig[e].connections[a].y*t})}selectAnimation(e){this.selectedAnimation=e;for(let t=0;t<this.connections.length;t++)this.connections[t].shape.selectAnimation(e)}updateRotationValues(){0==this.timeCounter?this.rotation=this.animations[this.selectedAnimation].initVals[this.shapeIndex]:this.rotation=this.getRotFromTimeStamps();for(let e=0;e<this.connections.length;e++)this.connections[e].shape.updateRotationValues();this.timeCounter++,this.timeCounter>this.animations[this.selectedAnimation].animLength&&(this.timeCounter=0)}display(e){e.save(),e.rotate(rad(this.rotation)),e.translate(-this.origin.x,-this.origin.y);for(let t=0;t<this.paths.length;t++)e.strokeStyle=this.colors[this.paths[t].stroke],e.fillStyle=this.colors[this.paths[t].fill],e.fill(this.paths[t].path),e.stroke(this.paths[t].path);for(let t=0;t<this.connections.length;t++)e.save(),e.translate(this.connections[t].x,this.connections[t].y),this.connections[t].shape.display(e),e.restore();e.restore()}getRotFromTimeStamps(){let e,t=this.animations[this.selectedAnimation].timeStamps[this.shapeIndex],a=!1;if(t.length>0){for(let i=0;i<t.length;i++)if(this.timeCounter<=t[i].time&&!a){let s=0,n=0;i>0?(s=t[i-1].time,n=t[i-1].rot):(s=0,n=this.animations[this.selectedAnimation].initVals[this.shapeIndex]),e=n+(this.timeCounter-s)/(t[i].time-s)*(t[i].rot-n),a=!0}if(!a){let a=t[t.length-1].time,i=t[t.length-1].rot;e=i+(this.timeCounter-a)/(this.animations[this.selectedAnimation].animLength-a)*(this.animations[this.selectedAnimation].initVals[this.shapeIndex]-i)}}return e}}let riglength,playerModel,monsterModel,cmess="",segments=[];function newSeg(e,t,a){let i={x:this.toNum(t,a),y:this.toNum(t+1,a)};segments.push({type:e,points:[i]})}function toNum(e,t){return cmess.charCodeAt(e)-t}function isns1(e,t){return e.charCodeAt(t)<ns2}function toAngle(e){return 180*this.toNum(e,ns2)/30}function unpackModelMessage(e){let t=e.split("*"),a=[];segments=[];for(let e=0;e<t.length;e++){cmess=t[e],segments=[];for(let a=5;a<t[e].length;a+=2)if(toNum(a,0)<ns2)newSeg("L",a,ns1);else{let e=segments.length-1;if(e>=0){let t=segments[e];if("L"==t.type)newSeg("C",a,ns2);else{let e=t.points;e.length<3?e.push({x:toNum(a,ns2),y:toNum(a+1,ns2)}):newSeg("C",a,ns2)}}else newSeg("C",a,ns2)}a.push({shape:toNum(0,ns1),fill:toNum(1,ns1),stroke:toNum(2,ns1),origin:{x:toNum(3,ns1),y:toNum(4,ns1)},segments:segments})}return a}function unpackRigMessage(e){let t=[],a=e;cmess=a;let i=0;for(let e=0;e<a.length;e++){let s=t[t.length-1];if(0==i)t.push({origin:{x:toNum(e,ns1)},connections:[],isRoot:!1});else if(1==i)s.origin.y=toNum(e,ns1);else if(i>2){let t=s.connections[s.connections.length-1];i%3==0?s.connections.push({x:toNum(e,ns2)}):i%3==1?s.connections[s.connections.length-1].y=toNum(e,ns2):t.shape=toNum(e,ns2)}else 2==i&&"1"==a[e]&&(s.isRoot=!0);++i>2&&isns1(a,e+1)&&(i=0)}return riglength=t.length,t}function unpackAnimation(e){let t=[];cmess=e;let a=e,i=!1,s=0;for(;!i;){let e=a.indexOf("*",s+1),n={name:a.substring(s+1,e)};n.animLength=toNum(e+1,ns1);let l=e+1+riglength;n.initVals=[],n.timeStamps=[];for(let t=e+2;t<l+1;t++)n.initVals.push(toAngle(t));s=l+1;for(let e=0;e<riglength;e++){n.timeStamps.push([]);let e=a.indexOf("*",s+1),t=0;for(let a=s+1;a<e;a++){let e=n.timeStamps[n.timeStamps.length-1];t%2==0?e.push({rot:toAngle(a)}):e[e.length-1].time=toNum(a,ns1),t++}s=e,-1==e&&(i=!0)}t.push(n)}return t}let edata={m:unpackModelMessage(":=:=Febqfmnnqlsht`y^o`i*;<:HGsgn_j`a`cmkj*<<:JBW@v]j^ld*=<:JBW@vmnklg*>::JFGI^^^_`_*?=:TPwororsrxwvws*@=:OUrrwtvw*@<:STzxzzvyozrzrx*A=:OProwowsvwrxrs*B=:STwtrrrx*B<:STzxzzvyozrzrx*<<:NAPDRATCV@*;;:H@mhfifefbiakc*;=:ECfgfchcjbkghf"),r:unpackRigMessage("CK1iiagtbctdEB0I@0IC0FF0lc_lf`he^QN0tucQR0QN0tueQR0"),a:unpackAnimation("*still*Z]]]]Y]]]]*****\\I*XI*YIaQ***walk*F]]]]`Qh]]*****\\@*c@*W@*N@**attack*Fa]]]]RdXa*c<e>**S<]>*`<]>*W<^>*N<S>*d<_>*X<d>*o<j>*dash*R`]]]]PeQs*`F*^L*TL\\N*jL\\N*c@\\FWL^N*a@PF^L*k@fF*S@QFOL*c@sF^L"),c:["rgba(142,203,0,0.0)","rgba(255,232,200,1.0)","rgba(177,91,0,1.0)","rgba(247,141,0,1.0)"]},pdata={m:unpackModelMessage(":;:JFHF*;;:PAo^e^fffppnqf*<<:DQip`hmkqmqulv*<=:DQexjylv*=>:=H_ddcckdmaq`k*>=:?L_mciepjpfubo*?>:@Hdmaq`k_ddcck*@=:?L_mciepjpfubo*A=:TJvirktntqzswm*B;:SNUOTRzuyvvvSQ*C=:QKrkviwmzstqtn*D;:SNUOTRzuyvvv*;=:PCrhojpfnjlimfEB*B=:SNsoylxr*D=:SNsoylxr*@;:@REONTOSKPloiogp@O*@:<@RFNNS"),r:unpackRigMessage("HM1nm`jwdkp_hwffmbHG0HM0kj^>D0bma?J0>D0bmc?J0RI0vpeSM0RI0vpgSM0"),a:unpackAnimation("*run*L^]]S]WV^^f**ZC**C*SC*cC*]C*`C*eC*VC*]C*gethit*F]]]]]]]]]]]*U=*Z=_B**H=XB*U=OB*T=aB*U=RB*a=[B*g=bB*n=^B*_=iB*fall*RbZ]YZlSQ]W]*]CbK*[CUK*]K*QCWK*^K*kCiK*[C[K*NCRK*kCaK*LC[K*jC`K*nothing*R]\\]Z]Y]Z_[^**_E**]E*VE*\\E*WE*****shooting*F]]]]]_[]]]]*[<*X<**W<*L<*U<*T<*_<*[<*_<*"),c:["rgba(254,255,247,0.0)","rgba(0,0,0,1.0)","rgba(255,154,33,1.0)","rgba(53,77,230,1.0)","rgba(240,112,0,1.0)"]};function loadModelData(){(playerModel=new CoolPath(0,0,pdata)).fullRig.selectAnimation(1)}class MovingObject extends DisplayObject{constructor(e,t,a,i){super(e,t,a,a),this.fill=i,this.hasGravity=!0,this.fallAcc=2,this.lrMaxSpeed=10,this.lrAcc=1,this.lrFriction=2,this.initJumpForce=25,this.movingLeft=!1,this.movingRight=!1,this.jumpForce=0,this.jumpDecel=2.2,this.fallSpeed=0,this.lrSpeed=0,this.impactForce={x:0,y:0},this.hitPoints=100}goLeft(){this.movingRight=!1,this.movingLeft=!0,this.facing="left"}goRight(){this.movingRight=!0,this.movingLeft=!1,this.facing="right"}display(){this.moveLeftRight(),this.applyPhysics(),this.position(),0!=this.screenPos&&(ctx.fillStyle=this.fill,ctx.fillRect(this.screenPos.x,this.screenPos.y,this.w,this.h),this.hitPoints<100&&this.displayHealthBar())}displayHealthBar(){let e=this.screenPos.y-25,t=this.screenPos.x;ctx.fillStyle="white",ctx.fillRect(t,e,30,10),ctx.fillStyle="red",ctx.fillRect(t,e,30*this.hitPoints/100,10)}jump(){this.jumpForce=this.initJumpForce}moveLeftRight(){this.movingLeft&&!this.movingRight?(this.lrSpeed-=this.lrAcc,this.lrSpeed=Math.max(this.lrSpeed,-this.lrMaxSpeed)):this.movingRight&&!this.movingLeft?(this.lrSpeed+=this.lrAcc,this.lrSpeed=Math.min(this.lrSpeed,this.lrMaxSpeed)):this.lrSpeed+this.lrFriction<0?this.lrSpeed+=this.lrFriction:this.lrSpeed-this.lrFriction>0?this.lrSpeed-=this.lrFriction:this.lrSpeed=0,this.impactForce.x>0?this.impactForce.x--:this.impactForce.x<0&&this.impactForce.x++,this.x+=this.lrSpeed+this.impactForce.x}applyPhysics(){this.updateFallSpeed(),this.jumpForce-this.jumpDecel>0?this.jumpForce-=this.jumpDecel:this.jumpForce=0,this.y+=this.fallSpeed-this.jumpForce}updateFallSpeed(){let e=level1.platforms,t=killLine;for(let a=0;a<e.length;a++)this.x>e[a].x-e[a].w2&&this.x<e[a].x+e[a].w2&&e[a].y>=this.y+this.h/2&&e[a].y<t&&(t=e[a].y,this.currentPlatform=a);this.y+this.h/2+this.fallSpeed<t?this.fallSpeed+=this.fallAcc:(this.y=t-this.h/2,this.impactForce.y=this.fallSpeed,this.impactForce.y>36&&(this.hitPoints-=this.impactForce.y/2),this.fallSpeed=0)}}class DisplayObject{constructor(e,t,a,i){this.x=e,this.y=t,this.w=a,this.h=i,this.w2=this.w/2,this.h2=this.h/2}position(){let e=getBounds(this);checkCollision(e,camera)?this.screenPos=getScreenPos(this):this.screenPos=!1}limitX(){this.x=Math.min(Math.max(this.x,-sceneW/2),sceneW/2)}shoot(e,t,a){e<this.screenPos.x?this.facing="left":this.facing="right",projectiles.push(new Projectile(this.x,this.y,4,"black",a,e,t))}}class Projectile extends MovingObject{constructor(e,t,a,i,s,n,l){super(e,t,a,i),this.destroyed=!1,this.y-=20,this.position();let o=this.screenPos,r=distance(o.x,o.y,n,l),c=s/r.d;this.speedVect={y:c*r.opp,x:c*r.adj},this.hasGravity=!1,this.lifeTimer=0}updateProjectile(){this.lifeTimer++,this.destroyed?this.display():(this.x+=this.speedVect.x,this.y+=this.speedVect.y,this.position(),0!=this.screenPos&&(this.checkForCollisions(level1.platforms,!1),this.checkForCollisions(enemies,10),this.checkWallCollisions(),ctx.fillStyle=this.fill,ctx.fillRect(this.screenPos.x,this.screenPos.y,this.w,this.h)))}checkWallCollisions(){(this.x<-sceneW/2||this.x>sceneW/2)&&this.stopProjectile()}checkForCollisions(e,t){for(let a=0;a<e.length;a++)if(checkCollision(getBounds(e[a]),getBounds(this))&&(this.stopProjectile(),0!=t)){e[a].hitPoints-=t,playBlaster(200,6);let i=t/2;e[a].impactForce.x+=Math.min(Math.max(e[a].x-this.x,-i),i)}}stopProjectile(){this.speedVect.x=0,this.speedVect.y=0,this.destroyed=!0}}let projectiles=[];function updateProjectiles(){for(let e=projectiles.length-1;e>=0;e--)projectiles[e].updateProjectile(),projectiles[e].lifeTimer>50&&projectiles.splice(e,1)}let saveData=null;function loadSave(){null==(saveData=JSON.parse(localStorage.getItem(saveDataHeader)))?newGameSave():console.log("Loaded Save")}function newGameSave(){console.log("new save"),saveData={levels:[]}}window.onbeforeunload=saveGame;let canvasElw,canvasElh,saveDataHeader="sams404gameforjs13kof2020";function saveGame(){localStorage.setItem(saveDataHeader,JSON.stringify(saveData))}function createCanvas(){canvas.w=600,canvas.h=400,canvas.w2=canvas.w/2,canvas.h2=canvas.h/2,canvas.c=document.createElement("canvas"),canvas.c.setAttribute("width",canvas.w),canvas.c.setAttribute("height",canvas.h),ctx=canvas.c.getContext("2d")}function resizeCanvas(){}window.onresize=resizeCanvas;let seedL=100,maxchar=100,charStart=128,ncount=0,random=()=>{let e=noiz(flo(ncount+=.7),currentLevel);return ncount%1*(noiz(Math.ceil(ncount),currentLevel)-e)+e},noiz=(e,t)=>(levelData.seedData.charCodeAt(e%seedL)-charStart)/maxchar,setupRandomSeed=e=>{let t="";for(let e=0;e<seedL;e++)t+=String.fromCharCode(charStart+randInt(maxchar));return t},constrain=(e,t,a)=>Math.min(Math.max(e,t),a),checkCollision=(e,t)=>oneDintercept(e.left,e.right,t.left,t.right)&&oneDintercept(e.top,e.bottom,t.top,t.bottom),oneDintercept=(e,t,a,i)=>t>=a&&t<=i||e>=a&&e<=i||e<=a&&t>=i,getScreenPos=e=>({x:canvas.w2+e.x-camera.target.x-e.w2,y:canvas.h2+e.y-camera.target.y-e.h2}),distance=(e,t,a,i)=>{let s=a-e,n=i-t;return{d:Math.sqrt(s*s+n*n),adj:s,opp:n}},getBounds=e=>({left:e.x-e.w2,right:e.x+e.w2,top:e.y-e.h2,bottom:e.y+e.h2}),div=(e,t)=>{let a=document.createElement("div");return document.body.appendChild(a),null!=e&&setStyle(a,e,t),a},setStyle=(e,t,a)=>e.setAttribute("style",`position:fixed; left:${t.x}px;top:${t.y}px;width:${t.w}px;height:${t.h}px;background-color:${a};`),rad=e=>e*Math.PI/180,l=e=>e.length,randInt=e=>flo(Math.random()*e),flo=e=>Math.floor(e),reach=(e,t,a)=>{e.x+a<t.x?e.x+=a:e.x-a>t.x?e.x-=a:e.x=t.x,e.y+a<t.y?e.y+=a:e.y-a>t.y?e.y-=a:e.y=t.y},last=e=>e[e.length-1],isLevel=e=>{let t=saveData.levels;for(let a=0;a<t.length;a++)if(t[a].name==e)return a;return-1},pointTo=e=>document.getElementById(e),cFill=e=>{ctx.fillStyle=e},cText=(e,t,a)=>{ctx.fillText(e,t,a)},cFont=e=>{ctx.font=e},cRect=(e,t,a,i)=>{ctx.fillRect(e,t,a,i)},aBar={},aBarFill="black";function setupActionBar(){(aBar={x:canvas.x,y:canvas.y+canvasElh,w:canvas.w,h:20}).el=div(aBar,aBarFill),aBar.w*=.2,aBar.health=div(aBar,"grey"),aBar.x+=aBar.w,aBar.inventory=div(aBar,"grey"),aBar.x+=aBar.w,aBar.w*=2,aBar.research=div(aBar,"grey"),aBar.x+=aBar.w,aBar.w/=2,aBar.save=div(aBar,"grey")}function aBarEl(){return div(aBar,"grey")}let addbar,textform,listform,levelData,waittime=5,runFadeIn=()=>{let e=1;fadeIn>waittime&&(e=1-(fadeIn-waittime)/30),e>0&&(ctx.fillStyle="rgba(0,0,0,"+e+")",ctx.fillRect(0,0,canvas.w,canvas.h)),fadeIn++},fade=e=>{fadeIn=0,waittime=e},addressbar=()=>{(addbar=div()).style.width=canvas.w+"px",addbar.style.backgroundColor="grey",updateFavorites(),document.body.appendChild(canvas.c);let e=canvas.c.getBoundingClientRect();canvas.x=Math.round(e.x),canvas.y=Math.round(e.y)},formKeyDown=()=>{13==event.keyCode&&(textform.value=textform.value.trim(),goToLink(),textform.blur())},inputListChanged=()=>{let e=listform.value;textform.value=e.substring(0,e.indexOf(" ")),goToLink()},setupLevel=()=>{let e=isLevel(currentLevel);-1!=e?levelData=saveData.levels[e]:(newLevel(dif),levelData=last(saveData.levels))},dif=0;function newLevel(e){0!=lvlCount&&lvlCount%lvlDiffIncreaseInterval==0&&(dif=Math.min(enemyDifficulty+1,maxEnemyDifficulty)),lvlCount++,null==e&&(e=currentlevel),saveData.levels.push({name:e,seedData:setupRandomSeed(),completion:0,difficulty:dif,unlocked:!1,cleared:!1})}function saveLevelData(){if(console.log("save level data"),"home"!=currentLevel&&"start"!=currentLevel){let e=isLevel(currentLevel);console.log("is level result "+e),saveData.levels[e].completion=levelData.completion,saveData.levels[e].unlocked=levelData.unlocked,saveData.levels[e].cleared=levelData.cleared}}function goToLink(){let e=listform.value,t=textform.value;if("start"==currentLevel){if("home"==t)return void loadHomeLevel();if("new"==t)return newGameSave(),void loadHomeLevel()}else 0!=saveData.levels.length&&(null!=levelData&&saveLevelData(),currentLevel="home"!=e?e.substring(0,e.indexOf(" ")):"home",t!=e&&""!=t&&(currentLevel=t),currentLevel==nextLink&&pickNextLinkAward(),"home"==currentLevel?loadHomeLevel():(fade(24),setupLevel(),createLevel(),createPlayer()))}let level1,loadHomeLevel=()=>{currentLevel="home",createLevel(),createPlayer(),fade(8)},allLinkNames=["contact","store","gallery","news","events","wormhole","destroy","noob","rekt","acidpool","badfile"],nextLink="",revealedLink="",revealedChars=0,dataCost=10,processDataStrips=()=>{""==nextLink&&pickNextLinkAward();let e=revealedLink.length,t=randInt(e);for(;"_"!=revealedLink[t];)t=randInt(e);revealedLink=t<nextLink.length-1?rSub(0,t)+nextLink[t]+rSub(t+1,e):rSub(0,t)+nextLink[t],++revealedChars==e&&(newLevel(nextLink),updateFavorites(),nextLink="")},rSub=(e,t)=>revealedLink.substring(e,t),randomlink=()=>allLinkNames[randInt(allLinkNames.length)],pickNextLinkAward=()=>{let e=randomlink();if(saveData.levels.length<allLinkNames.length)for(;-1!=isLevel(e);)e=randomlink();else{let t=4+randInt(4);e="";for(let a=0;a<t;a++)e+=String.fromCharCode(97+randInt(26))}nextLink=e,revealedLink="",revealedChars=0;for(let e=0;e<nextLink.length;e++)revealedLink+="_"},displayStartUI=()=>{cFill("white"),cRect(0,0,canvas.w,canvas.h),cFill("black"),cText("sam's js13k game",50,50),cText("type 'home' in the address bar above to continue saved game,",50,65),cText("or type 'new' to start a new game.",50,80)},tFormSelected=!1,updateFavorites=()=>{let e="<option> home </option>";"start"==currentLevel&&0==saveData.levels.length&&(e="");for(let t=0;t<saveData.levels.length;t++){let a=saveData.levels[t];e+=`<option>${a.name} difficulty: ${a.difficulty}</option>`}let t=`favorites:<select id="favorites" onchange=inputListChanged()> ${e} </select>`;addbar.innerHTML=` <span onclick='back()'> < </span> <span onclick='forward()'> > </span>\n      www.coolshoes.com/<input type='text' id='tinput' onkeydown='formKeyDown()'></input>\n      <span onclick='goToLink()'>go</span>\n      ${t}  `,textform=pointTo("tinput"),listform=pointTo("favorites"),textform.onfocus=(()=>tFormSelected=!0),textform.onblur=(()=>tFormSelected=!1),saveGame()},back=()=>console.log("back"),forward=()=>console.log("forward"),sceneW=0,fadeIn=0,enemies=[],lvlCount=0,enemyDifficulty=1,lvlDiffIncreaseInterval=3,maxEnemyDifficulty=3,platInterval=65,maxExtraPlatW=150,minPlatW=50,basicLevel=()=>{level1=new Level([[50,killLine-100,100],[-60,killLine-60,100],[0,killLine,canvas.w]],sceneW,100)},randPlat=e=>Math.min(minPlatW+random()*maxExtraPlatW,(sceneW-e)/2),createLevel=()=>{if(noiseCounter=0,enemies=[],items=[],firstEnemyKilled=!1,sceneW=canvas.w,cantGoDown=!1,"home"==currentLevel)basicLevel(),createFriendlyNPCs();else if("true404"==currentLevel){basicLevel();let e=last(level1.platforms);level1.text404=new DisplayObject(e.x-10,e.y-10,300,300)}else{sceneW=2*canvas.w;let e=[[0,killLine,sceneW]],t=5+flo(8*random()),a=killLine,i=.6*(-sceneW/2+random()*sceneW),s=randPlat(i);for(let n=0;n<t-1;n++){maxExtraPlatW=n%4==2?300:40,a-=platInterval,e.push([i,a,s]);let t=flo(3*random())-1;if(i<-50||i>50){let e=sceneW/2-i;t=Math.abs(e)/e}i+=t*flo(60*random()),s=randPlat(i)}let n=last(e);n[0]=sceneW/8,n[2]=1.2*sceneW,level1=new Level(e,sceneW,Math.abs(e[0][1]-e[e.length-1][1])),n=last(level1.platforms),level1.text404=new DisplayObject(n.x-10,n.y-10,300,300),level1.enemyDifficulty=levelData.difficulty,level1.cleared=levelData.cleared,levelData.unlocked?(firstEnemyKilled=!0,cantGoDown=!1):(cantGoDown=!0,n.fill="orange",enemies.push(new Enemy(n.x,n.y-80,level1.platforms.length-1)),enemies[0].jumpy=!1)}updateFavorites()},linestyle=(e,t,a)=>{ctx.strokeStyle=e+t,ctx.lineWidth=a};class Level{constructor(e,t,a){let i="index.html";"home"!=currentLevel&&(i="js/characters/enemyclass.js"),fetch(i).then(e=>e.text()).then(e=>this.bgText=e),this.unbg=[],this.uncorrupting=!1,this.platforms=[],this.bgFill="#ddff";for(let t=0;t<e.length;t++)this.platforms.push(new Platform(e[t][0],e[t][1],e[t][2]));this.walls=[new DisplayObject(-.75*t,0,t/2,2e3),new DisplayObject(.75*t,0,t/2,2e3),new DisplayObject(0,killLine+500,2e3,1e3)],this.bgTxt=new DisplayObject(t/2,this.platforms[0].y+a,2*t,4*a)}displayBackground(){if(cFill(this.bgFill),cRect(0,0,canvas.w,canvas.h),this.bgTxt.position(),0!=this.bgTxt.screenPos){if(cFont("30px Arial"),this.uncorrupting){let e=randInt(6e3),t=randInt(20);for(let a=0;a<t;a++)this.unbg.includes(e+a)||this.unbg.push(e+a)}let e=0,t=-1+randInt(3);for(let a=0;a<50;a++){let i="f";a<10&&(i=a);let s=this.bgTxt.screenPos.x,n=this.bgText.substring(120*a,120*(a+1));for(let l=0;l<120;l++)"home"==currentLevel||this.unbg.includes(e)?lineStyle("#bbb",i,2):lineStyle("#bdb",i,12+t),ctx.strokeText(n[l],s,(this.bgTxt.screenPos.y+50*a)/2),e++,s+=1.2*ctx.measureText(n[l]).width}ctx.lineWidth=1}}display404Background(){this.text404.position(),cFont("100px Georgia"),cFill("black"),cText("404",this.text404.screenPos.x,this.text404.screenPos.y),cFont("30px Georgia"),cText("return to last page...",this.text404.screenPos.x,this.text404.screenPos.y+50)}displayPlatforms(){for(let e=0;e<this.platforms.length;e++)this.platforms[e].display();cFill("black");for(let e=0;e<this.walls.length;e++){let t=this.walls[e];t.position();let a=t.screenPos;0!=a&&ctx.fillRect(a.x,a.y,t.w,t.h)}}displayCompletion(){let e=levelData.completion+"% complete";cFont("40px bold"),cFill("black"),cText(e,10,30),cFill("white"),cText(e,12,32)}}let platformHeight=10,platformFill="#a43f";class Platform extends DisplayObject{constructor(e,t,a){super(e,t,a,platformHeight),this.fill=platformFill}display(){this.position(),0!=this.screenPos&&(ctx.fillStyle=this.fill,ctx.fillRect(this.screenPos.x,this.screenPos.y,this.w,this.h))}}window.onload=start;let currentLevel="start",killLine=500;function start(){loadSave(),fadeIn=0,createCanvas(),addressbar(),setupActionBar(),resizeCanvas(),loadModelData(),startSound(),setInterval(run,33)}function run(){if("start"!=currentLevel){let e="home"==currentLevel;cameraFollow(player.x,player.y),level1.displayBackground(),e||level1.display404Background(),level1.displayPlatforms(),e&&runFriendlyNPCs(),updateEnemies(),updatePlayer(),updateProjectiles(),runDialog(),updateItems(),runFadeIn(),e||level1.displayCompletion()}else displayStartUI()}
