let aContext;const twoPI=2*Math.PI;let samprate,startSound=()=>{window.AudioContext=window.AudioContext||window.webkitAudioContext,aContext=new AudioContext,samprate=aContext.sampleRate},pls=(e,t,a,s)=>{let i=[],l=samprate*(t.a+t.d+t.r),n=samprate/e,r=flo(n)*a,o=n/twoPI,h=[];for(let e=0;e<r;e++)h.push(s(e,o));for(let e=0;e<l;e++)i[e]=.4*t.level(e)*h[e%r];return i},ps=(e,t,a,s,i)=>{let l=new Float32Array(e.length);for(var n=0;n<e.length;n++)l[n]=t*e[n];let r=aContext.createBuffer(1,l.length,samprate);r.copyToChannel(l,0);let o=aContext.createBufferSource();o.buffer=r;let h=aContext.createBiquadFilter();o.connect(h),h.connect(aContext.destination),o.start(0),h.type=a,h.frequency.value=s,h.gain.value=i};class Envelope{constructor(e,t,a,s){this.a=e,this.d=t,this.s=a,this.r=s,this.aS=e*samprate,this.dS=t*samprate,this.rS=s*samprate,this.rT=this.aS+this.dS}level(e){return e<this.aS?e/this.aS:e<this.rT?1-(1-this.s)*(e-this.aS)/this.dS:this.s*(1-(e-this.rT)/this.rS)}}let ctx,aboutguy,bar=1800,maxbars=16,startBeatMachine=()=>setInterval(newbar,bar),beatinput=[{vals:"x x 0 x xxx 0 x x x xxx x x",beatval:32,f:playHats},{vals:"x  xx",beatval:8,f:playKick,v:200,p:!1},{vals:"xoxxx",beatval:5,f:playSnare,p:!1},{vals:"",beatval:3,f:pbla,v:360,p:!1},{vals:"/  --",beatval:6,f:playWobbleBass,v:0,p:!1},{vals:"",beatval:8,f:playHardHat,p:!1},{vals:"  M   N",beatval:8,f:playNoiseySynth,v:0,p:!1},{vals:"MNRW  V  W  YZYW",beatval:16,f:playSine,v:0,p:!1}],bars=0,section=0,noteToFreq=e=>13.75*2**((e-9)/12),newbar=()=>{let e=beatinput[0],t=beatinput[6],a=beatinput[4],s=beatinput[1],i=beatinput[5],l=beatinput[2];switch(section){case 0:e.p=!0,t.p=!0,a.p=!0,wubfactor=200;break;case 1:t.p=!1,s.p=!0,i.p=!0,wubfactor=400;break;case 2:l.p=!0,snarerelease=.2,wubfactor=600;break;case 3:t.p=!0,s.p=!1,wubfactor=200}section%2==1&&(random()>.3&&bars%2==1?(s.vals="x  x  x x     x",s.beatval=16):(s.vals="x  xx",s.beatval=8)),section>=0&&(bars%2==0?(l.vals="x xxx",l.beatval=5,i.vals="xoooxooo"):(l.vals="x  x",l.beatval=8,i.vals="oxox0x0x"));for(let e=0;e<beatinput.length;e++)if(beatinput[e].p)for(let t=0;t<beatinput[e].vals.length;t++)"x"==beatinput[e].vals[t]?null!=beatinput[e].v?setTimeout(function(e,t){e(t)},t*bar/beatinput[e].beatval,beatinput[e].f,beatinput[e].v):setTimeout(function(e){e()},t*bar/beatinput[e].beatval,beatinput[e].f):null!=beatinput[e].v&&" "!=beatinput[e].vals[t]&&setTimeout(function(e,t){e(t)},t*bar/beatinput[e].beatval,beatinput[e].f,noteToFreq(beatinput[e].vals.charCodeAt(t)-20));++bars==maxbars&&(bars=0,section++)},sine4ctr=0,sine4fact=.2,constSineB=(e,t)=>constrain(Math.round(Math.sin(e/(t+e/100))),0,.1),constSineB2=(e,t)=>constrain(Math.round(Math.sin(e/(t+e/1e3))),0,.1),noisey=(e,t)=>.02*Math.random(),noisey2=(e,t)=>Math.random()*constrain(Math.round(Math.sin(e/(e+t))),0,.13),constSine=(e,t)=>constrain(Math.sin(e/t),-.2,.2),constSine2=(e,t)=>constrain(.5*(Math.sin(e/t)+Math.sin(e/(20+t))),0,.1),constSine3=(e,t)=>constrain(.2*Math.random()*(Math.sin(e/t)+Math.sin(e/(100+t))),0,.1),constSine4=(e,t)=>constrain(Math.random()*sine4fact+.3*(Math.sin(e/t)+.3*Math.sin(e/(2+t))),0,.1),snarerelease=.3,playSnare=()=>{ps(pls(10,new Envelope(.02,.01,.3,snarerelease),4,noisey2),5,"highpass",2200,4)},playHats=()=>{ps(pls(400,new Envelope(.01,.01,.1,.2),40,noisey),14,"highpass",1400,12)},wubfactor=560,playWobbleBass=e=>{ps(pls(e,new Envelope(.05,.51,.2,.51),60,constSine2),5,"lowshelf",wubfactor,10)},playNoiseySynth=e=>{ps(pls(e,new Envelope(.01,.11,.3,1.45),50,constSine4),8,"lowpass",1500,8),++sine4ctr%12==0&&(sine4fact=1-sine4fact)},playHardHat=()=>{ps(pls(8,new Envelope(.01,.01,.11,.13),1,constSine3),6,"lowshelf",2240,12)},playKick=e=>{ps(pls(e,new Envelope(.01,.11,.3,.35),500,constSineB),18,"lowpass",180,12)},pbla=(e,t)=>{ps(pls(e,new Envelope(.01,.11,.3,.25),100,constSineB2),t,"highpass",1080,8)},playSine=e=>{ps(pls(e,new Envelope(.01,.11,.3,.35),1,constSine),1,"notch",280,28)},playDamageFX=()=>{ps(pls(20,new Envelope(.01,.11,.3,.31),60+Math.floor(20*Math.random()),constSine3),14,"highshelf",1500,2)},canvas={},cam={},scam=()=>{cam.target={x:player.x,y:player.y},cam.w=canvas.w2,cam.h=canvas.h2,cam.speed=24},camFollow=(e,t)=>{t-=50,reach(cam.target,{x:e,y:t},cam.speed),cam.left=cam.target.x-cam.w,cam.right=cam.target.x+cam.w,cam.top=cam.target.y-cam.h,cam.bottom=cam.target.y+cam.h},firstEnemyKilled=!1,maxEnemies=3,enemyShooterDamage=10,updateEnemies=()=>{if("home"!=currentLevel&&"start"!=currentLevel)for(let e=enemies.length-1;e>=0;e--)if(enemies[e].update(),enemies[e].hp<=0){if(generateLoot(enemies[e]),"spawner"==enemies[e].type){let t=!0;for(let a=0;a<enemies.length;a++)"spawner"==enemies[a].type&&a!=e&&(t=!1);t&&(levelData.sections++,coL(!0))}else{levelData.completion=Math.min(levelData.completion+1,100);for(let t=0;t<enemies.length;t++)"spawner"==enemies[t].type&&enemies[t].sIndex==enemies[e].sIndex&&enemies[t].ecnt--}enemies.splice(e,1),level1.uncorrupting=!0,levelData.completion<100&&setTimeout(function(){level1.uncorrupting=!1},2e3)}};class Enemy extends Mo{constructor(e,t,a,s,i){let l="#cc30";"spawner"==i&&(l="#cc3f"),super(e,t,40,l),this.type=i,this.cup=a,this.nwt(),this.trd=10,this.tco=0,this.roaming=!0,this.gra="none",this.jumpy=!0,this.roamPauseLength=1600,this.ackc=0,this.nAt=0,this.aiN=25,this.facing,this.attackPower=20,this.dashInterval=20,this.nextDash=0,this.dashCount=15,this.facing="left",this.lrs=!1,this.aaot,"flyer"==i?(this.model=new CoolPath(0,0,fedata),this.model.colors[2]="rgba(147,141,220,1.0)"):(this.model=new CoolPath(0,0,edata),"shooter"==i&&(this.model.colors[2]="rgba(147,241,5,1.0)")),this.sIndex=s,this.sint=200,this.aou=0,this.ecnt=0,this.ftar=[],this.flightVel=4,this.fDi=1,Math.random()>.5&&(this.fDi=-1),this.neS=0}updateSpawner(){let e=this.display();0!=e&&cRect(e.x,e.y,40,40,"gold"),this.aou++}spawnMore(){if(this.neS--,this.ecnt<4&&this.aou>=this.neS){let e=Math.random(),t="fighter";e>.66?t="flyer":e>.33&&(t="shooter"),this.ecnt++,this.neS=this.aou+50,enemies.push(new Enemy(this.x,this.y-80,this.cup,this.sIndex,t))}}update(){if("spawner"!=this.type){if(this.display(),0!=this.sP){this.ackc++;let e=distance(player.x,player.y,this.x,this.y);"fighter"==this.type?(this.fight(e),this.roam(e)):"flyer"==this.type?(this.fallSpeed=0,this.enemyShooter(e),this.fly(e)):"shooter"==this.type&&(this.enemyShooter(e),this.roam(e)),this.hp<100&&(this.hp+=.2),this.model.x=this.sP.x+20,this.model.y=this.sP.y+20,this.model.update(ctx,"left"==this.facing)}}else this.updateSpawner()}flyBy(){let e={x:this.x,y:player.y-60-10+randInt(20)};this.ftar.length>0&&((e=this.ftar[0]).y+=-70+randInt(20));this.x<player.x-200?this.fDi=1:this.x>player.x+200&&(this.fDi=-1),e.x+=this.fDi*randInt(100),console.log("added target ",e),this.ftar.push(e)}fly(e){if(0==this.ftar.length)e.d<130?(console.log("go to player"),this.ftar.push({x:player.x,y:player.y}),this.flyBy()):this.flyBy();else{distance(this.ftar[0].x,this.ftar[0].y,this.x,this.y);reach(this,this.ftar[0],this.flightVel)&&this.ftar.shift(),console.log(this.x,this.y)}}enemyShooter(e){this.nAt<this.ackc&&e.d<200&&player.y>this.y-100&&player.y<this.y+100&&(pbla(800,1),this.shoot(player.sP.x,player.sP.y,10,!0),this.aM(2),this.nAt=this.ackc+this.aiN,this.ree())}ree(){this.aaot=setTimeout(function(e){e.roaming?e.aM(1):e.aM(0)},400,this)}fight(e){this.nAt<this.ackc&&e.d<30&&player.y>this.y-50&&player.y<this.y+50&&(dpl(this.attackPower),this.aM(2),this.nAt=this.ackc+this.aiN,this.ree())}roam(e){this.roaming&&(player.cup==this.cup&&this.nextDash<this.ackc&&e.d<220?(this.nextDash=this.ackc+this.dashInterval,this.dashCount=0,this.target=player.x-30+60*Math.random(),clearTimeout(this.aaot),this.aM(3)):this.lrs||this.aM(1),this.dashCount<15?(this.dashCount++,this.lrMaxSpeed=7,15==this.dashCount&&this.aM(1)):this.lrMaxSpeed=2,this.x+this.trd<this.target?this.goRight():this.x-this.trd>this.target?this.goLeft():(this.roaming=!1,this.mR=!1,this.mL=!1,this.tco%3==0&&("up"==this.gra?this.jump():"down"==this.gra&&(this.y+=4)),this.aM(0),setTimeout(function(e){e.roaming=!0,e.nwt()},this.roamPauseLength,this))),this.lrs=this.roaming}aM(e){clearTimeout(this.aaot),this.model.san(e)}nwt(){this.tco++;let e=level1.platforms[this.cup];level1.platforms[player.cup];if(player.y==this.y)this.target=.4*(e.x-e.w2+Math.random()*e.w);else{let t=gbo(e),a=!1;for(let s=0;s<level1.platforms.length;s++){if(a)return;let i=gbo(level1.platforms[s]),l=-1,n=-1;if(t.left>=i.left&&t.right<=i.right?(l=t.left,n=e.w):t.left<=i.left&&t.right>=i.right?(l=i.left,n=level1.platforms[s].w):i.right>=t.left&&i.right<=t.right?(l=t.left,n=i.left+level1.platforms[s].w-t.left):i.left>=t.left&&i.left<=t.right&&(l=i.left,n=t.left+e.w-i.left),-1!=l){let t=level1.platforms[s].y-e.y;this.y<player.y&&t>0&&t<150?(console.log("moving down"),a=!0,this.target=l+randInt(n),this.gra="down"):this.y>player.y&&t<0&&t>-100&&(a=!0,this.target=l+randInt(n),this.gra="up")}}a||(this.target=.4*(e.x-e.w2+Math.random()*e.w))}}}let player,playerMoving,createFriendlyNPCs=()=>{let e=level1.platforms[level1.platforms.length-1];aboutguy=new Mo(e.x+150,e.y-30,20,nocolor)},runFriendlyNPCs=()=>{aboutguy.display(),enableInteraction(aboutguy,"press E",50),0!=aboutguy.sP&&(aboutModel.x=aboutguy.sP.x+8,aboutModel.y=aboutguy.sP.y-24,aboutModel.update(ctx,!1))},enableInteraction=(e,t,a)=>{if(0!=e.sP){if(distance(player.x,player.y,e.x,e.y).d<a){e.iRb=!0;let a=e.sP;ctx.fillText(t,a.x+25,a.y-40,"black",10)}else e.iRb=!1}else e.iRb=!1},createPlayer=()=>{let e=level1.platforms[level1.platforms.length-1];"home"==currentLevel?e=level1.platforms[0]:e.x-=130,(player=new Mo(e.x,e.y-100,40,"#2a20")).facing="left",player.jetFuel=100,player.gnp=100,scam(),player.display()},lastPlayerMovingState=!1,playerJumping=!1,fuelcost=7,shotcost=38,updatePlayer=()=>{player.limitX(),player.jetpacks&&player.jup<10?player.jetFuel>=fuelcost?(player.jetFuel-=fuelcost,player.jup=10):(cantjetpack=!0,setTimeout(function(){cantjetpack=!1},500),player.jetpacks=!1):player.jup>0?player.jup-=2:player.jup=0,player.display(),playerModel.x=player.sP.x+20,playerModel.y=player.sP.y+10,playerMoving=!1,(player.mL||player.mR)&&(playerMoving=!0),(player.jup>0||player.fallSpeed>0)&&!playerJumping?(playerJumping=!0,playerModel.fullRig.san(2)):0==player.jup&&playerJumping?(playerJumping=!1,rPA()):playerMoving&&!lastPlayerMovingState?playerModel.fullRig.san(0):!playerMoving&&lastPlayerMovingState&&playerModel.fullRig.san(3),lastPlayerMovingState=playerMoving,playerModel.update(ctx,"left"==player.facing),player.hp<100&&(player.hp+=.1),aBar.health.innerHTML="health: "+Math.floor(player.hp),player.hp<=0&&(loadHomeLevel(),fade(60,"ouchies")),player.gnp=Math.min(player.gnp+4,100),player.jetFuel=Math.min(player.jetFuel+4,100)},rPA=()=>{playerMoving?playerModel.fullRig.san(0):playerModel.fullRig.san(3)},dpl=e=>{player.hp-=e,playDamageFX(),playerModel.san(1),setTimeout(function(){rPA()},400)},texts=["Hmm? # Oh! You must be from the cleaning service. # Thank goodness you're here. # Our web page is being attacked by a mysterious slimey virus! # Our pages have been replaced by fake 404s, monsters and slime. # Yuck! It's revolting! Here, let me add our directory to your favorites.","We must clear the virus from this website. # I suspect other infected files have been implanted in the servers. # Bring back any clues you might find and we'll track them down!"],dUI={open:!1,t:0,ctr:0,line:[],lineI:0,dtt:""},dialogNum=0,dialogDone=!1,maxCharsPerLine=20,runDialog=()=>{if(dUI.open){if(0!=dUI.t){let e=getsP({x:dUI.t.x,y:dUI.t.y,w2:50,h2:50});dUI.x=e.x,dUI.y=e.y-70}cFill("white"),cRect(dUI.x,dUI.y,190,42),cFill("black"),cFont(16),cText(dUI.dtt[0],dUI.x+5,dUI.y+18),cText(dUI.dtt[1],dUI.x+5,dUI.y+36)}aboutguy.iRb||(dUI.open=!1)},continueDialog=()=>{if(dialogDone){switch(dUI.open=!1,dialogDone=!1,dialogNum){case 0:for(let e=0;e<2;e++)newLevel(allLinkNames[e]);ufa()}aboutguy.iRb&&dialogNum<texts.length-1&&dialogNum++}else cutDialog()},cutDialog=()=>{let e=makeLine(),t={t:""};e.stop||(t=makeLine()),dUI.dtt=[e.t,t.t]},makeLine=()=>{let e="",t=!1,a=!1;for(;!t&&!a&&e.length+dUI.line[0].length<maxCharsPerLine;)"#"==dUI.line[0]?a=!0:e+=dUI.line[0]+" ",dUI.line.shift(),0==dUI.line.length&&(t=!0,dialogDone=!0);return{t:e,stop:t}},actionButton=()=>{"home"==currentLevel&&aboutguy.iRb&&(dUI.open?continueDialog():(dUI.open=!0,dUI.t=aboutguy,dUI.line=texts[dialogNum].split(" "),revealedLink.includes("_")||pnl(),cutDialog()))},cantGoDown=!1,cantjetpack=!1,keypress=()=>{if(!tFormSelected)switch(event.keyCode){case 65:player.goLeft();break;case 68:player.goRight();break;case 32:!player.jetpacks&&player.jup<8&&player.jump(),cantjetpack||(player.jetpacks=!0);break;case 83:player.y<killLine&&!cantGoDown&&player.y++;break;case 69:actionButton();break;case 27:dUI.open=!1}},keyrelease=()=>{if(!tFormSelected)switch(event.keyCode){case 65:player.mL=!1;break;case 68:player.mR=!1;break;case 32:player.jetpacks=!1}},mouseIsPressed=!1,mouseX=0,mouseY=0,cantShoot=!1;const playerShotCooldown=100;let mousePressed=()=>{mouseIsPressed=!0,mouseX=event.clientX-canvas.x,mouseY=event.clientY-canvas.y,"start"!=currentLevel&&!cantShoot&&player.gnp>=shotcost&&(player.gnp-=shotcost,pbla(1800,3),player.shoot(mouseX,mouseY,15,!1),playerModel.san(4),cantShoot=!0,setTimeout(function(){rPA(),cantShoot=!1},100))},mouseReleased=()=>mouseIsPressed=!1,datastrip=0,addLoot=()=>{updateInv(++datastrip),datastrip>dataCost&&(datastrip-=dataCost,processDataStrips(),updateInv(datastrip))},updateInv=e=>{let t="";""!=revealedLink&&(t=". Next url: "+revealedLink),aBar.ivv.innerHTML="data strips: "+e+" / "+dataCost,aBar.research.innerHTML=t},items=[],generateLoot=e=>{let t=5+randInt(15);for(let a=0;a<t;a++){items.push(new Item(e.x,e.y-50,10,"grey"));let t=items[items.length-1];t.impactForce.x=6+randInt(12),Math.random()>.5&&(t.impactForce.x*=-1),t.initjup=11,t.jump()}},updateItems=()=>{for(let e=items.length-1;e>=0;e--)items[e].update(),items[e].looted&&items.splice(e,1)};class Item extends Mo{constructor(e,t,a,s){super(e,t,a,s),this.looted=!1,this.v=1}update(){if(!this.looted){let e=distance(this.x,this.y,player.x,player.y);if(e.d<10)this.looted=!0,addLoot();else if(e.d<80){this.v++;let t=this.v/e.d;this.x+=t*e.adj,this.y+=t*e.opp,this.fallSpeed=0}else this.v>1&&this.v--;let t=this.display();0!=t&&cRect(t.x,t.y,20,20,"grey")}}}let lastp,ns1=58,ns2=93;class CoolPath{constructor(e,t,a,s){this.x=e,this.y=t,this.cmess,this.scale=1.5,null!=s&&(this.scale*=s),this.colors=[];for(let e=0;e<a.c.length;e++)this.colors[e]=a.c[e];this.model=a.m,this.rig=a.r,this.aio=a.a;for(let e=0;e<this.rig.length;e++)this.rig[e].isRoot&&(this.fullRig=new RigShape(e,this.scale,this.model,this.rig,this.aio,this.colors));this.san(1),this.ctr=0}san(e){this.pose=e,this.fullRig.san(e)}update(e,t){this.fullRig.rov(),ctx.translate(this.x,this.y),t&&ctx.scale(-1,1),this.fullRig.display(ctx),ctx.resetTransform(),this.ctr++,this.ctr>this.aio[this.pose].animLength&&(this.ctr=0)}}class RigShape{constructor(e,t,a,s,i,l){this.colors=l,this.rig=s,this.aio=i,this.sIndex=e,this.origin={x:s[e].origin.x*t,y:s[e].origin.y*t},this.rotation=0,this.paths=[],this.ctr=0;for(let s=0;s<a.length;s++)if(a[s].shape==e){let e=a[s].origin,i=e.x*t,l=e.y*t,n=`M ${i} ${l} `,r=a[s].segments;for(let e=0;e<r.length;e++){n+=r[e].type+" ";let a=r[e].points;for(let e=0;e<a.length;e++)n+=`${i=a[e].x*t} ${l=a[e].y*t} `}this.paths.push({path:new Path2D(n),stroke:a[s].stroke,fill:a[s].fill})}this.pins=[];for(let n=0;n<s[e].pins.length;n++){let r=s[e].pins[n];this.pins.push({shape:new RigShape(r.shape,t,a,s,i,l),x:r.x*t,y:r.y*t})}}san(e){this.pose=e;for(let t=0;t<this.pins.length;t++)this.pins[t].shape.san(e)}rov(){0==this.ctr?this.rotation=this.aio[this.pose].iva[this.sIndex]:this.rotation=this.grft();for(let e=0;e<this.pins.length;e++)this.pins[e].shape.rov();this.ctr++,this.ctr>this.aio[this.pose].animLength&&(this.ctr=0)}display(e){e.save(),e.rotate(rad(this.rotation)),e.translate(-this.origin.x,-this.origin.y);for(let t=0;t<this.paths.length;t++){cFill(this.colors[this.paths[t].fill]),e.fill(this.paths[t].path);let a=this.colors[this.paths[t].stroke];a!=nocolor&&(e.strokeStyle=a,e.stroke(this.paths[t].path))}for(let t=0;t<this.pins.length;t++)e.save(),e.translate(this.pins[t].x,this.pins[t].y),this.pins[t].shape.display(e),e.restore();e.restore()}grft(){let e=this.aio[this.pose],t=e.timeStamps[this.sIndex];if(t.length>0){for(let a=0;a<t.length;a++)if(this.ctr<=t[a].time){setlast(0,0);let s=t[a-1];return a>0?setlast(s.time,s.rot):setlast(0,e.iva[this.sIndex]),this.lerprot(t[a].time,t[a].rot)}let a=last(t);return setlast(a.time,a.rot),this.lerprot(e.animLength,e.iva[this.sIndex])}}lerprot(e,t){return lastp.r+(this.ctr-lastp.t)/(e-lastp.t)*(t-lastp.r)}}let riglength,playerModel,monsterModel,aboutModel,setlast=(e,t)=>lastp={t:e,r:t},cmess="",segments=[],newSeg=(e,t,a)=>segments.push({type:e,points:[{x:toNum(t,a),y:toNum(t+1,a)}]}),toNum=(e,t)=>cmess.charCodeAt(e)-t,isns1=(e,t)=>e.charCodeAt(t)<ns2,toAngle=e=>180*toNum(e,ns2)/30,upmm=e=>{let t=e.split("*"),a=[];segments=[];for(let e=0;e<t.length;e++){cmess=t[e],segments=[];for(let a=5;a<t[e].length;a+=2)if(toNum(a,0)<ns2)newSeg("L",a,ns1);else{let e=segments.length-1;if(e>=0){let t=segments[e],s=t.points;"L"==t.type?newSeg("C",a,ns2):s.length<3?s.push({x:toNum(a,ns2),y:toNum(a+1,ns2)}):newSeg("C",a,ns2)}else newSeg("C",a,ns2)}a.push({shape:toNum(0,ns1),fill:toNum(1,ns1),stroke:toNum(2,ns1),origin:{x:toNum(3,ns1),y:toNum(4,ns1)},segments:segments})}return a},uprm=e=>{let t=[],a=e;cmess=a;let s=0;for(let e=0;e<a.length;e++){let i=t[t.length-1];if(0==s)t.push({origin:{x:toNum(e,ns1)},pins:[],isRoot:!1});else if(1==s)i.origin.y=toNum(e,ns1);else if(s>2){let t=i.pins[i.pins.length-1];s%3==0?i.pins.push({x:toNum(e,ns2)}):s%3==1?i.pins[i.pins.length-1].y=toNum(e,ns2):t.shape=toNum(e,ns2)}else 2==s&&"1"==a[e]&&(i.isRoot=!0);++s>2&&isns1(a,e+1)&&(s=0)}return riglength=t.length,t},upai=e=>{let t=[];cmess=e;let a=e,s=!1,i=0;for(;!s;){let e=a.indexOf("*",i+1),l={name:a.substring(i+1,e)};l.animLength=toNum(e+1,ns1);let n=e+1+riglength;l.iva=[],l.timeStamps=[];for(let t=e+2;t<n+1;t++)l.iva.push(toAngle(t));i=n+1;for(let e=0;e<riglength;e++){l.timeStamps.push([]);let e=a.indexOf("*",i+1),t=0;for(let a=i+1;a<e;a++){let e=l.timeStamps[l.timeStamps.length-1];t%2==0?e.push({rot:toAngle(a)}):e[e.length-1].time=toNum(a,ns1),t++}i=e,-1==e&&(s=!0)}t.push(l)}return t},nocolor="#0000",enemyhead=":=:=Febqfmnnqlsht`y^o`i*;<:HGsgn_j`a`cmkj*<<:JBW@v]j^ld*=<:JBW@vmnklg*>::JFGI^^^_`_*",edata={m:upmm(enemyhead+"?=:TPwororsrxwvws*@=:OUrrwtvw*@<:STzxzzvyozrzrx*A=:OProwowsvwrxrs*B=:STwtrrrx*B<:STzxzzvyozrzrx*<<:NAPDRATCV@*;;:H@mhfifefbiakc*;=:ECfgfchcjbkghf"),r:uprm("CK1iiagtbctdEB0I@0IC0FF0lc_lf`he^QN0tucQR0QN0tueQR0"),a:upai("*still*Z]]]]Y]]]]*****\\I*XI*YIaQ***walk*F]]]]`Qh]]*****\\@*c@*W@*N@**attack*Fa]]]]RdXa*c<e>**S<]>*`<]>*W<^>*N<S>*d<_>*X<d>*o<j>*dash*R`]]]]PeQs*`F*^L*TL\\N*jL\\N*c@\\FWL^N*a@PF^L*k@fF*S@QFOL*c@sF^L"),c:[nocolor,"rgba(255,232,200,1.0)","rgba(177,91,0,1.0)","rgba(247,141,0,1.0)"]},abdata={m:upmm(":;:?Uiqcgkgsgmqsx*:=:GUEUhzbvc{GX*:=:IUKUnzuvs{IX*;<:KCplfmhf*;;:NCBCFBe_p^pbJ@KB*;:;IFGF*;:;FDhhkijg*;:;IDlinhmg"),r:uprm("HK1ki^HF0"),a:upai("*still*H]`**YA"),c:[nocolor,"rgba(157,95,194,1.0)","rgba(207,206,253,1.0)","rgba(232,255,79,1.0)"]},fedata={m:upmm(enemyhead+";;:H@mhfifefbiakc*;=:ECfgfchcjbkghf*?=:PEkdp_el`spnmkPI*@<:ANckgjgohuav_o*A=:?Dkbhallopgqgi?H*B<:JMnlfjkrmtqrrm"),r:uprm("CK1jldcnbgiaEB0I@0IC0FF0lc_lf`he^OG0fncCK0@D0kneHK0"),a:upai("*fly*Dj][]NGkYQ*f?**]?**Y?*e?*Y?*F?*Y?*atkfly*Di]\\]UH]V]*l?**P=S?]A*f=i<]A*N=J>XA*[?*f?*??*Z?*still*Zd]]]ZIj^O*fF**]OVQTW*bQfW*TFQOZQAW*GF*kF*\\F*KF"),c:edata.c},pdata={m:upmm(":;:JFHF*;;:PAo^e^fffppnqf*<<:DQip`hmkqmqulv*<=:DQexjylv*=>:=H_ddcckdmaq`k*>=:?L_mciepjpfubo*?>:@Hdmaq`k_ddcck*@=:?L_mciepjpfubo*A=:TJvirktntqzswm*B;:SNUOTRzuyvvvSQ*C=:QKrkviwmzstqtn*D;:SNUOTRzuyvvv*;=:PCrhojpfnjlimfEB*B=:SNsoylxr*D=:SNsoylxr*@;:@REONTOSKPloiogp@O*@:<@RFNNS"),r:uprm("HM1nm`jwdkp_hwffmbHG0HM0kj^>D0bma?J0>D0bmc?J0RI0vpeSM0RI0vpgSM0"),a:upai("*run*L^]]S]WV^^f**ZC**C*SC*cC*]C*`C*eC*VC*]C*gethit*F]]]]]]]]]]]*U=*Z=_B**H=XB*U=OB*T=aB*U=RB*a=[B*g=bB*n=^B*_=iB*fall*RbZ]YZlSQ]W]*]CbK*[CUK*]K*QCWK*^K*kCiK*[C[K*NCRK*kCaK*LC[K*jC`K*nothing*R]\\]Z]Y]Z_[^**_E**]E*VE*\\E*WE*****shooting*F]]]]]_[]]]]*[<*X<**W<*L<*U<*T<*_<*[<*_<*"),c:[nocolor,"rgba(0,0,0,1.0)","rgba(255,154,33,1.0)","rgba(53,77,230,1.0)","rgba(240,112,0,1.0)"]},loadModelData=()=>{(playerModel=new CoolPath(0,0,pdata)).san(1),(aboutModel=new CoolPath(0,0,abdata,2)).san(0)};const friction=2;class Mo extends DisplayObject{constructor(e,t,a,s){super(e,t,a,a),this.fill=s,this.hasGravity=!0,this.fallAcc=2,this.lrMaxSpeed=10,this.lrAcc=1,this.initjup=25,this.mL=!1,this.mR=!1,this.jup=0,this.jumpDecel=2.2,this.fallSpeed=0,this.lrSpeed=0,this.impactForce={x:0,y:0},this.hp=100,this.jetpacks=!1}goLeft(){this.mR=!1,this.mL=!0,this.facing="left"}goRight(){this.mR=!0,this.mL=!1,this.facing="right"}display(){this.moveLeftRight(),this.applyPhysics();let e=this.position();return this.hp<100&&this.displayHealthBar(),e}displayHealthBar(){progressBar(this.sP.x,this.sP.y-25,30,10,this.hp,"red","white")}jump(){this.jup=this.initjup}moveLeftRight(){this.mL&&!this.mR?(this.lrSpeed-=this.lrAcc,this.lrSpeed=Math.max(this.lrSpeed,-this.lrMaxSpeed)):this.mR&&!this.mL?(this.lrSpeed+=this.lrAcc,this.lrSpeed=Math.min(this.lrSpeed,this.lrMaxSpeed)):this.lrSpeed+friction<0?this.lrSpeed+=friction:this.lrSpeed-friction>0?this.lrSpeed-=friction:this.lrSpeed=0,this.impactForce.x>0?this.impactForce.x--:this.impactForce.x<0&&this.impactForce.x++,this.x+=this.lrSpeed+this.impactForce.x}applyPhysics(){this.updateFallSpeed(),this.jup-this.jumpDecel>0?this.jup-=this.jumpDecel:this.jup=0,this.jetpacks&&(this.fallSpeed=0),this.y+=this.fallSpeed-this.jup}updateFallSpeed(){let e=level1.platforms,t=killLine;for(let a=0;a<e.length;a++)this.x>e[a].x-e[a].w2&&this.x<e[a].x+e[a].w2&&e[a].y>=this.y+this.h/2&&e[a].y<t&&(t=e[a].y,this.cup=a);this.y+this.h/2+this.fallSpeed<t?this.fallSpeed+=this.fallAcc:(this.y=t-this.h/2,this.impactForce.y=this.fallSpeed,this.fallSpeed=0)}}class DisplayObject{constructor(e,t,a,s){this.x=e,this.y=t,this.w=a,this.h=s,this.w2=this.w/2,this.h2=this.h/2}position(){return ckco(gbo(this),cam)?this.sP=getsP(this):this.sP=!1,this.sP}limitX(){this.x=Math.min(Math.max(this.x,-sceneW/2),sceneW/2)}shoot(e,t,a,s){e<this.sP.x?this.facing="left":this.facing="right",projectiles.push(new Projectile(this.x,this.y,4,"black",a,e,t,s))}}class Projectile extends Mo{constructor(e,t,a,s,i,l,n,r){super(e,t,a,s),this.hitsplayer=r,this.destroyed=!1,this.y-=20;let o=this.position(),h=distance(o.x,o.y,l,n),c=i/h.d;this.speedVect={y:c*h.opp,x:c*h.adj},this.hasGravity=!1,this.lifeTimer=0}updateProjectile(){if(this.lifeTimer++,this.destroyed)this.display();else{this.x+=this.speedVect.x,this.y+=this.speedVect.y,cFill("#4a8f");let e=this.position();this.size=10,0!=e&&(this.hitsplayer?ckco(gbo(this),gbo(player))&&(this.stopProjectile(),this.bump(player,8),playDamageFX(),dpl(enemyShooterDamage)):(this.checkForCollisions(level1.platforms,!1),this.checkForCollisions(enemies,25),cFill(this.fill),this.size=3),this.checkWallCollisions(),cRect(e.x,e.y,this.size,this.size))}}checkWallCollisions(){(this.x<-sceneW/2||this.x>sceneW/2)&&this.stopProjectile()}checkForCollisions(e,t){for(let a=0;a<e.length;a++)ckco(gbo(e[a]),gbo(this))&&(this.stopProjectile(),0!=t&&("spawner"==e[a].type?(t=5,e[a].spawnMore()):this.bump(e[a],4),pbla(200,6),e[a].hp-=t))}bump(e,t){e.impactForce.x+=Math.min(Math.max(e.x-this.x,-t),t)}stopProjectile(){this.speedVect.x=0,this.speedVect.y=0,this.destroyed=!0}}let projectiles=[],updateProjectiles=()=>{for(let e=projectiles.length-1;e>=0;e--)projectiles[e].updateProjectile(),projectiles[e].lifeTimer>50&&projectiles.splice(e,1)},saveData=null,loadSave=()=>{null==(saveData=JSON.parse(localStorage.getItem(saveDataHeader)))?newGameSave():console.log("Loaded Save")},newGameSave=()=>{console.log("new save"),saveData={levels:[]}};window.onbeforeunload=saveGame;let canvasElw,canvasElh,addbar,textform,listform,levelData,level1,saveDataHeader="sams404gameforjs13kof2020",saveGame=()=>localStorage.setItem(saveDataHeader,JSON.stringify(saveData)),createCanvas=()=>{canvas.w=800,canvas.h=600,canvas.w2=canvas.w/2,canvas.h2=canvas.h/2,canvas.c=document.createElement("canvas"),canvas.c.setAttribute("width",canvas.w),canvas.c.setAttribute("height",canvas.h),ctx=canvas.c.getContext("2d")},seedL=100,maxchar=100,charStart=128,ncount=0,random=()=>{let e=noiz(flo(ncount+=.7),currentLevel);return ncount%1*(noiz(Math.ceil(ncount),currentLevel)-e)+e},noiz=(e,t)=>(levelData.seedData.charCodeAt(e%seedL)-charStart)/maxchar,setupRandomSeed=e=>{let t="";for(let e=0;e<seedL;e++)t+=String.fromCharCode(charStart+randInt(maxchar));return t},constrain=(e,t,a)=>Math.min(Math.max(e,t),a),ckco=(e,t)=>oneDintercept(e.left,e.right,t.left,t.right)&&oneDintercept(e.top,e.bottom,t.top,t.bottom),oneDintercept=(e,t,a,s)=>t>=a&&t<=s||e>=a&&e<=s||e<=a&&t>=s,getsP=e=>({x:canvas.w2+e.x-cam.target.x-e.w2,y:canvas.h2+e.y-cam.target.y-e.h2}),progressBar=(e,t,a,s,i,l,n)=>{cFill(n),cRect(e,t,a,s),cFill(l),cRect(e,t,a*i/100,s)},distance=(e,t,a,s)=>{let i=a-e,l=s-t;return{d:Math.sqrt(i*i+l*l),adj:i,opp:l}},gbo=e=>({left:e.x-e.w2,right:e.x+e.w2,top:e.y-e.h2,bottom:e.y+e.h2}),div=(e,t)=>{let a=document.createElement("div");return document.body.appendChild(a),null!=e&&setStyle(a,e,t),a},setStyle=(e,t,a)=>e.setAttribute("style",`position:fixed; left:${t.x}px;top:${t.y}px;width:${t.w}px;height:${t.h}px;background-color:${a};`),rad=e=>e*Math.PI/180,l=e=>e.length,randInt=e=>flo(Math.random()*e),flo=e=>Math.floor(e),reach=(e,t,a)=>{let s=!1,i=!1;return e.x+a<t.x?e.x+=a:e.x-a>t.x?e.x-=a:(e.x=t.x,s=!0),e.y+a<t.y?e.y+=a:e.y-a>t.y?e.y-=a:(e.y=t.y,i=!0),!(!s||!i)},last=e=>e[e.length-1],isLevel=e=>{let t=saveData.levels;for(let a=0;a<t.length;a++)if(t[a].name==e)return a;return-1},pointTo=e=>document.getElementById(e),cFill=e=>{ctx.fillStyle=e},cText=(e,t,a,s,i)=>{s&&cFill(s),i&&cFont(i),ctx.fillText(e,t,a)},cFont=e=>{ctx.font=e+"px Courier New"},cRect=(e,t,a,s,i)=>{i&&cFill(i),ctx.fillRect(e,t,a,s)},aBar={},aBarFill="black",setupActionBar=()=>{(aBar={x:canvas.x,y:canvas.y+canvasElh,w:canvas.w,h:20}).el=div(aBar,aBarFill),aBar.w*=.2,aBar.health=div(aBar,"grey"),aBar.x+=aBar.w,aBar.ivv=div(aBar,"grey"),aBar.x+=aBar.w,aBar.w*=2,aBar.research=div(aBar,"grey"),aBar.x+=aBar.w,aBar.w/=2,aBar.save=div(aBar,"grey")},aBarEl=()=>div(aBar,"grey"),waittime=5,runFadeIn=()=>{let e=1;fadeIn>waittime&&(e=1-(fadeIn-waittime)/30),e>0&&(cRect(0,0,canvas.w,canvas.h,"rgba(0,0,0,"+e+")"),cText(fadetxt,canvas.w/2-30,canvas.h/2-2,"white",20)),fadeIn++},fadetxt="",fade=(e,t)=>{fadeIn=0,waittime=e,fadetxt=null!=t?t:""},addressbar=()=>{(addbar=div()).style.width=canvas.w+"px",addbar.style.backgroundColor="grey",ufa(),document.body.appendChild(canvas.c);let e=canvas.c.getBoundingClientRect();canvas.x=Math.round(e.x),canvas.y=Math.round(e.y)},formKeyDown=()=>{13==event.keyCode&&(textform.value=textform.value.trim(),goToLink(),textform.blur())},inputListChanged=()=>{let e=listform.value;textform.value=e.substring(0,e.indexOf(" ")),goToLink()},setupLevel=()=>{let e=isLevel(currentLevel);-1!=e?levelData=saveData.levels[e]:(newLevel(dif),levelData=last(saveData.levels))},dif=0,newLevel=e=>{0!=lvlCount&&lvlCount%lvlDiffIncreaseInterval==0&&(dif=Math.min(enemyDifficulty+1,maxEnemyDifficulty)),lvlCount++,null==e&&(e=currentlevel),saveData.levels.push({name:e,seedData:setupRandomSeed(),difficulty:dif,cleared:!1,sections:0})},saveLevelData=()=>{if("home"!=currentLevel&&"start"!=currentLevel){let e=isLevel(currentLevel);saveData.levels[e].cleared=levelData.cleared,sadeData.levels[e].sections=levelData.sections}},goToLink=()=>{let e=listform.value,t=textform.value;if("start"==currentLevel){if("home"==t)return void loadHomeLevel();if("new"==t)return newGameSave(),void loadHomeLevel()}else 0!=saveData.levels.length&&(null!=levelData&&saveLevelData(),currentLevel="home"!=e?e.substring(0,e.indexOf(" ")):"home",t!=e&&""!=t&&(currentLevel=t),currentLevel==nextLink&&pnl(),"home"==currentLevel?loadHomeLevel():(fade(24),setupLevel(),createLevel(),createPlayer()))},loadHomeLevel=()=>{currentLevel="home",createLevel(),createPlayer(),fade(8)},allLinkNames=["contact","store","gallery","news","events","wormhole","destroy","noob","rekt","acidpool","badfile"],nextLink="",revealedLink="",revealedChars=0,dataCost=10,processDataStrips=()=>{""==nextLink&&pnl();let e=revealedLink.length,t=randInt(e);for(;"_"!=revealedLink[t];)t=randInt(e);revealedLink=t<nextLink.length-1?rSub(0,t)+nextLink[t]+rSub(t+1,e):rSub(0,t)+nextLink[t],++revealedChars==e&&(newLevel(nextLink),ufa(),nextLink="")},rSub=(e,t)=>revealedLink.substring(e,t),randomlink=()=>allLinkNames[randInt(allLinkNames.length)],pnl=()=>{let e=randomlink();if(saveData.levels.length<allLinkNames.length)for(;-1!=isLevel(e);)e=randomlink();else{let t=4+randInt(4);e="";for(let a=0;a<t;a++)e+=String.fromCharCode(97+randInt(26))}nextLink=e,revealedLink="",revealedChars=0;for(let e=0;e<nextLink.length;e++)revealedLink+="_"},displayStartUI=()=>{cRect(0,0,canvas.w,canvas.h,"white"),cFill("black"),cText("sam's js13k game",50,50),cText("type 'home' in the address bar above to continue saved game,",50,65),cText("or type 'new' to start a new game.",50,80)},tFormSelected=!1,ufa=()=>{let e="<option> home </option>";"start"==currentLevel&&0==saveData.levels.length&&(e="");for(let t=0;t<saveData.levels.length;t++){let a=saveData.levels[t];e+=`<option>${a.name} difficulty: ${a.difficulty}</option>`}let t=`favorites:<select id="favorites" onchange=inputListChanged()> ${e} </select>`;addbar.innerHTML=` <span onclick='back()'> < </span> <span onclick='forward()'> > </span>\n      www.coolshoes.com/<input type='text' id='tinput' onkeydown='formKeyDown()'></input>\n      <span onclick='goToLink()'>go</span>\n      ${t}  `,textform=pointTo("tinput"),listform=pointTo("favorites"),textform.onfocus=(()=>tFormSelected=!0),textform.onblur=(()=>tFormSelected=!1),saveGame()},back=()=>console.log("back"),forward=()=>console.log("forward"),killLine=500,sceneW=0,fadeIn=0,enemies=[],lvlCount=0,enemyDifficulty=1,lvlDiffIncreaseInterval=3,maxEnemyDifficulty=3,basicLevel=e=>{sceneW=canvas.w,level1=new Level([[50,killLine-100,100],[-60,killLine-60,100],[0,killLine,canvas.w]],sceneW,100,e)},coL=e=>{let t=[[0,killLine+=500,sceneW]],a=flo(3+3*random()),s=flo(1+3*random()),i=-canvas.w+random()*sceneW;for(let e=0;e<s;e++){let s=killLine;for(let e=0;e<a;e++){let l=50;s-=60,e==a-1&&(l=150,enemies.push(new Enemy(i,s-80,0,0,"spawner"))),t.push([i,s,l+50*random()]),i+=80*random()-40}0==e?Math.abs(i)<300?i-=600:i*=-1:i=-1*i+400}for(let e=0;e<t.length;e++)level1.platforms.push(new Platform(t[e][0],t[e][1],t[e][2]));level1.newWalls(sceneW)},createLevel=()=>{if(noisectr=0,enemies=[],items=[],killLine=500,dUI.open=!1,"home"==currentLevel)basicLevel(),createFriendlyNPCs();else if("true404"==currentLevel)basicLevel(!0);else{sceneW=2*canvas.w;let e=(level1=new Level([[0,killLine,sceneW]],sceneW,400,!0)).platforms[0],t=levelData.sections;if(0==t)enemies.push(new Enemy(e.x,e.y-80,0,0,"spawner"));else for(let e=0;e<t;e++)coL(e==t-1);ufa()}};class Level{constructor(e,t,a,s){let i="index.html";if("home"!=currentLevel&&(i="js/characters/enemyclass.js"),fetch(i).then(e=>e.text()).then(e=>this.bgText=e),null!=s){let t=e[0];this.text404=new DisplayObject(t[0]-10,t[1]-10,300,300)}this.platforms=[],this.bgFill="#ddff";for(let t=0;t<e.length;t++)this.platforms.push(new Platform(e[t][0],e[t][1],e[t][2]));this.newWalls(sceneW),this.bgTxt=new DisplayObject(t/2,this.platforms[0].y+a,2*t,4*a),this.bgctr=0,this.thunder=100,this.txtctr=0,this.drops=[]}newWalls(e){this.walls=[new DisplayObject(-.75*e,0,e/2,2e3),new DisplayObject(.75*e,0,e/2,2e3),new DisplayObject(0,killLine+500,2e3,1e3)]}displayBackground(){if(cRect(0,0,canvas.w,canvas.h,"#333F"),this.bgctr>this.thunder){let e=10-(this.bgctr-this.thunder);e>=0?cRect(0,0,canvas.w,canvas.h,"#FFF"+e):Math.random()<.3?this.thunder+=50+randInt(100):this.thunder+=200+randInt(200)}let e=this.bgTxt.position();for(let t=this.drops.length-1;t>=0;t--){let a=this.drops[t];a.y+=20,cText(level1.bgText[a.c],e.x+a.x,e.y+a.y,"#bbba",12),a.y>killLine&&this.drops.splice(t,1)}this.bgctr%1==0&&this.drops.push({x:randInt(sceneW),y:-500,c:randInt(400)}),this.bgctr++}display404Background(){let e=this.text404.position();cText("404",e.x,e.y,"black",100),cText("return to last page...",e.x,e.y+50,"black",30)}displayPlatforms(){this.txtctr=0;for(let e=0;e<this.platforms.length;e++)this.platforms[e].display();cFill("black");for(let e=0;e<this.walls.length;e++){let t=this.walls[e],a=t.position();0!=a&&ctx.fillRect(a.x,a.y,t.w,t.h)}}countT(){this.txtctr++,this.txtctr>=this.bgText.length&&(this.txtctr=0)}}let platformHeight=10,platformFill="#a43f";class Platform extends DisplayObject{constructor(e,t,a){super(e,t,a,platformHeight),this.fill=platformFill}display(){let e=this.position();if(0!=this.sP){ctx.strokeStyle=this.fill,ctx.strokeRect(e.x,e.y,this.w,20),null==this.txtStart?this.txtStart=level1.txtctr:level1.txtctr=this.txtStart;let t="";for(let e=0;e<6;e++){for(;level1.txtctr<level1.bgText.length&&level1.bgText.charCodeAt(level1.txtctr)<24;)level1.countT();t+=level1.bgText[level1.txtctr],level1.countT()}cText(t,e.x+12,e.y+15,this.fill,20)}}}let start=()=>{loadSave(),fadeIn=0,createCanvas(),addressbar(),setupActionBar(),loadModelData(),startSound(),setInterval(run,33)};window.onload=start;let currentLevel="start",run=()=>{if("start"!=currentLevel){let e="home"==currentLevel;camFollow(player.x,player.y),level1.displayBackground(),e||level1.display404Background(),level1.displayPlatforms(),e&&runFriendlyNPCs(),updateEnemies(),updatePlayer(),updateProjectiles(),runDialog(),updateItems(),runFadeIn(),progressBar(10,canvas.h-40,100,30,player.gnp,"orange","grey"),progressBar(canvas.w-110,canvas.h-40,100,30,player.jetFuel,"blue","grey")}else displayStartUI()};
